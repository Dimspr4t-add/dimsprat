<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Scanner Tiket - Fullscreen</title>
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      background:#000; color:#fff;
      font-family: Arial, sans-serif;
      overflow:hidden;
    }
    #reader {
      width:100%; height:100%;
      object-fit:cover;
    }
    .overlay {
      position: absolute;
      top:0; left:0; right:0; bottom:0;
      display:flex; flex-direction:column; justify-content:space-between;
      pointer-events:none;
    }
    .top-bar, .bottom-bar {
      background:rgba(0,0,0,0.4);
      padding:10px;
      display:flex; justify-content:space-between; align-items:center;
      pointer-events:auto;
    }
    .status {
      text-align:center;
      padding:8px;
      font-size:14px;
      border-radius:6px;
    }
    .ok { background:#0a0; }
    .error { background:#a00; }
    .info { background:#444; }
    button {
      background:rgba(255,255,255,0.15);
      border:none; color:#fff;
      padding:8px 12px; margin:0 4px;
      border-radius:6px; font-size:14px;
      cursor:pointer;
    }
    button:active { background:rgba(255,255,255,0.3); }
  </style>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div id="reader"></div>
  <div class="overlay">
    <div class="top-bar">
      <div id="status" class="status info">Siap scan...</div>
    </div>
    <div class="bottom-bar">
      <button id="switchBtn">üîÑ Ganti Kamera</button>
      <button id="flashBtn">üí° Flash</button>
      <button id="stopBtn">‚èπ Stop</button>
    </div>
  </div>

<script>
const VERIFY_URL = "https://script.google.com/macros/s/AKfycbxEXAMPLE/exec"; // ganti
const API_TOKEN  = "CHANGE_THIS_TOKEN"; // ganti

let html5QrCode;
let currentCameraId = null;
let cameras = [];
let flashOn = false;

const statusEl = document.getElementById("status");
const switchBtn = document.getElementById("switchBtn");
const flashBtn = document.getElementById("flashBtn");
const stopBtn = document.getElementById("stopBtn");

function setStatus(msg, type="info"){
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
}

async function verifyTicket(code) {
  setStatus("Memverifikasi...", "info");
  try {
    const resp = await fetch(VERIFY_URL + "?ticket=" + encodeURIComponent(code) + "&token=" + API_TOKEN);
    const json = await resp.json();
    if (json.ok && json.status === "ok") {
      setStatus("‚úÖ Tiket VALID - " + (json.name||""), "ok");
      playBeep(1000);
    } else if (json.ok && json.status === "used") {
      setStatus("‚ö†Ô∏è Tiket SUDAH dipakai - " + (json.name||""), "error");
      playBeep(600);
    } else {
      setStatus("‚ùå Tiket TIDAK valid", "error");
      playBeep(300);
    }
  } catch (e) {
    setStatus("Gagal koneksi", "error");
  }
}

function playBeep(freq=1000) {
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type="sine"; osc.frequency.value=freq;
  osc.connect(gain); gain.connect(ctx.destination);
  gain.gain.setValueAtTime(0.2, ctx.currentTime);
  osc.start(); osc.stop(ctx.currentTime+0.2);
}

async function startCamera(cameraId){
  if(html5QrCode){
    await html5QrCode.stop().catch(()=>{});
    document.getElementById("reader").innerHTML="";
  }
  html5QrCode = new Html5Qrcode("reader");
  currentCameraId = cameraId;

  html5QrCode.start(
    cameraId,
    { fps:15, qrbox:{width:250, height:250} },
    qrCodeMessage => {
      if (qrCodeMessage) {
        html5QrCode.pause(true);
        verifyTicket(qrCodeMessage).finally(()=>{
          setTimeout(()=>html5QrCode.resume(),1200);
        });
      }
    },
    errorMessage => {}
  ).then(() => {
    setStatus("Kamera aktif", "info");
  }).catch(err => {
    setStatus("Gagal buka kamera: " + err, "error");
  });
}

async function init(){
  try {
    cameras = await Html5Qrcode.getCameras();
    if(cameras.length===0){ setStatus("Tidak ada kamera", "error"); return; }
    // default: kamera belakang jika ada
    let cam = cameras[0].id;
    for (let c of cameras) {
      if(/back|rear/i.test(c.label)) { cam = c.id; break; }
    }
    startCamera(cam);
  } catch(e){
    setStatus("Error akses kamera: "+e, "error");
  }
}

switchBtn.onclick = ()=>{
  if(cameras.length<2){ setStatus("Hanya ada 1 kamera", "info"); return; }
  const idx = cameras.findIndex(c=>c.id===currentCameraId);
  const next = cameras[(idx+1)%cameras.length];
  startCamera(next.id);
};

flashBtn.onclick = async ()=>{
  if(!html5QrCode) return;
  try {
    const capabilities = await html5QrCode.getRunningTrackCapabilities();
    if(capabilities.torch){
      flashOn = !flashOn;
      await html5QrCode.applyVideoConstraints({ advanced: [{torch: flashOn}] });
      flashBtn.textContent = flashOn ? "üí° Flash ON" : "üí° Flash OFF";
    } else {
      setStatus("Flash tidak didukung", "info");
    }
  } catch(e){
    setStatus("Tidak bisa toggle flash", "error");
  }
};

stopBtn.onclick = async ()=>{
  if(html5QrCode){
    await html5QrCode.stop();
    document.getElementById("reader").innerHTML="";
    setStatus("Scanner berhenti", "info");
  }
};

init();
</script>
</body>
</html>
