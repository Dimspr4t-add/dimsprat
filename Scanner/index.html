<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Tiket</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #121212; color: #fff; margin:0; padding:0;}
  #reader { width: 300px; margin: 30px auto; }
  #processing { display: none; margin-top: 15px; font-weight: bold; color: #00f; }

  /* Modal */
  .modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left:0; top:0; 
    width:100%; height:100%; 
    background: rgba(0,0,0,0.7); 
    justify-content: center; align-items: center;
  }

  .modal-content {
    background: #1e1e1e; 
    padding: 30px; 
    border-radius: 15px; 
    width: 90%; max-width: 400px; 
    text-align: center; 
    animation: fadeIn 0.3s ease;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    position: relative;
  }

  .modal h3 { margin-bottom: 15px; font-size: 1.5rem; }
  .modal p { margin-bottom: 20px; line-height: 1.5; }

  .modal button {
    padding: 10px 20px; 
    background: #00bfff; 
    color: #000; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: bold; 
    transition: 0.2s;
  }

  .modal button:hover { background: #009acd; }

  .success { border: 3px solid #0f0; color: #0f0; }
  .error { border: 3px solid #f00; color: #f00; }
  .warning { border: 3px solid #ffa500; color: #ffa500; }

  @keyframes fadeIn { from {opacity:0; transform: scale(0.9);} to {opacity:1; transform: scale(1);} }

  @media(max-width: 480px) {
    .modal-content { padding: 20px; }
    .modal h3 { font-size: 1.2rem; }
  }
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h2>üì∑ Scanner Tiket Check-In</h2>
<div id="reader"></div>
<div id="processing">üîÑ Memproses...</div>

<!-- Modal -->
<div id="resultModal" class="modal">
  <div id="modalContent" class="modal-content">
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <button onclick="closeModal()">Tutup</button>
  </div>
</div>

<!-- Suara -->
<audio id="beepValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="beepInvalid" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
<audio id="beepUsed" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
  const SHEET_API = "https://script.google.com/macros/s/AKfycby_KZar7ssIv9wK5CRHUe0t-VoKmfgf-ihUHNvjIMH1O2R4zZWQeDDI_ETt2v54fGE/exec"; // Ganti URL GAS

  const beepValid = document.getElementById("beepValid");
  const beepInvalid = document.getElementById("beepInvalid");
  const beepUsed = document.getElementById("beepUsed");

  function showModal(type, title, message) {
    const modal = document.getElementById("resultModal");
    const modalContent = document.getElementById("modalContent");
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalMessage").innerText = message;

    modalContent.className = "modal-content"; // reset
    if(type==="success"){ modalContent.classList.add("success"); beepValid.play(); }
    else if(type==="warning"){ modalContent.classList.add("warning"); beepUsed.play(); }
    else { modalContent.classList.add("error"); beepInvalid.play(); }

    modal.style.display="flex";

    // Auto-close modal 3 detik
    setTimeout(closeModal, 3000);
  }

  function closeModal(){
    document.getElementById("resultModal").style.display="none";
  }

  function updateProcessing(show){
    document.getElementById("processing").style.display = show ? "block" : "none";
  }

  function onScanSuccess(decodedText, decodedResult){
    updateProcessing(true);
    fetch(`${SHEET_API}?code=${encodeURIComponent(decodedText)}`)
      .then(res=>res.json())
      .then(data=>{
        updateProcessing(false);
        if(data.valid){
          showModal("success","‚úÖ Tiket Valid", `Nama: ${data.nama}\nTiket: ${data.ticket || '-'}`);
        } else if(data.message && data.message.includes("dipakai")){
          showModal("warning","‚ö†Ô∏è Tiket Sudah Terpakai", data.message);
        } else {
          showModal("error","‚ùå Tiket Tidak Valid", data.message || "Kode tidak ditemukan");
        }
      })
      .catch(err=>{
        updateProcessing(false);
        showModal("error","‚ùå Error","Gagal menghubungkan ke server");
      });
  }

  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},onScanSuccess)
    .catch(err=>{ updateProcessing(false); showModal("error","‚ùå Kamera Tidak Bisa Diakses","Pastikan perangkat memiliki kamera dan izinkan akses."); });
</script>

</body>
</html>
