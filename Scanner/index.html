<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Check-In Scanner ‚Äî Full</title>

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
  :root{
    --bg:#0f1113; --card:#15171a; --accent:#ff2d2d; --muted:#9aa0a6; --success:#27ae60; --warn:#f39c12; --danger:#e74c3c;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Rajdhani',sans-serif;background:var(--bg);color:#fff;min-height:100vh;display:flex;flex-direction:column}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,#0b0c0d,#141516)}
  header h1{font-size:18px;margin:0;font-family:'Orbitron',sans-serif}
  nav{display:flex;gap:8px}
  nav button{background:transparent;border:1px solid #222;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button.active{background:var(--accent);border-color:var(--accent);box-shadow:0 6px 20px rgba(255,45,45,0.12)}

  main{flex:1;padding:20px;display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;justify-content:center}
  .panel{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:980px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .center{display:flex;flex-direction:column;align-items:center;gap:12px}

  /* Mode selection */
  .mode-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .btn{background:var(--accent);border:none;padding:12px 18px;border-radius:10px;color:#fff;cursor:pointer;font-weight:700}
  .btn.secondary{background:transparent;border:1px solid #2b2b2b;color:var(--muted)}
  .btn.ghost{background:transparent;border:1px dashed #2b2b2b;color:var(--muted)}

  /* Scanner area */
  #reader {width:320px;margin:0 auto}
  .processing{display:flex;align-items:center;gap:10px;color:var(--muted);margin-top:8px}
  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.8));backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:999}
  .modal.show{display:flex}
  .modal-card{background:linear-gradient(180deg,#0f1214,#151617);padding:22px;border-radius:14px;min-width:300px;max-width:420px;text-align:center;box-shadow:0 14px 38px rgba(0,0,0,0.6)}
  .modal-card h1{font-size:48px;margin:0}
  .modal-card h3{margin:12px 0 8px;font-size:20px}
  .modal-card p{margin:0;color:var(--muted);white-space:pre-line}
  .modal-card .actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:13px;margin-top:10px}

  /* Table (history) */
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:var(--muted);font-weight:600;font-size:13px}
  tbody tr:hover td{background:rgba(255,255,255,0.01)}

  /* Responsive */
  @media(max-width:720px){
    main{padding:12px}
    .panel{padding:14px}
  }

  /* Tambahan status badge */
  .status-success { color:#27ae60; font-weight:600 }
  .status-warning { color:#f39c12; font-weight:600 }
  .status-error { color:#e74c3c; font-weight:600 }
  
  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  .btn-approve {
    background: #27ae60;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-approve:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
  .btn-reject {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-reject:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<header>
  <h1>üéüÔ∏è Check-In Scanner</h1>
  <nav>
    <button id="tabScanner" class="active" onclick="showPage('scanner')">Scanner</button>
    <button id="tabHistory" onclick="showPage('history')">Histori</button>
    <button id="tabOts" onclick="showPage('ots')">OTS</button>
    <button onclick="logout()">Logout</button>
  </nav>
</header>

<main>
  <!-- SCANNER PANEL -->
  <section id="scanner" class="panel center">
    <div style="max-width:640px;width:100%;">
      <h2 style="margin:0 0 8px;font-size:18px">Mode</h2>
      <div class="mode-buttons" id="modeSelection">
        <button class="btn" onclick="enterCameraMode()">üì∑ Scan QR</button>
        <button class="btn secondary" onclick="enterManualMode()">‚å®Ô∏è Input Manual</button>
      </div>

      <!-- camera area -->
      <div id="cameraArea" style="display:none;margin-top:14px;" class="center">
        <div id="reader"></div>
        <div class="processing" id="procCamera" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
        <div style="margin-top:12px;">
          <button class="btn ghost" onclick="stopScanner()">Stop Camera</button>
        </div>
      </div>

      <!-- manual area -->
      <div id="manualArea" style="display:none;margin-top:14px;" class="center">
        <input id="manualInput" type="text" placeholder="Masukkan ID tiket / Kode QR" style="padding:12px;border-radius:10px;border:1px solid #222;width:100%;max-width:420px;background:#0b0c0d;color:#fff">
        <div style="margin-top:12px;">
          <button class="btn" onclick="submitManual()">Check-In</button>
          <button class="btn secondary" onclick="backToMode()">Batal</button>
        </div>
        <div class="processing" id="procManual" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
      </div>
    </div>
  </section>

  <!-- HISTORY PANEL -->
  <section id="history" class="panel" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:18px">Histori Check-in</h2>
      <div>
        <button class="btn" onclick="loadHistory()">üîÑ Refresh</button>
        <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
      </div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Timestamp</th><th>Nama</th><th>Jumlah</th><th>Jenis Tiket</th><th>Status</th><th>QR Code</th><th>Kode Pesanan</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="6">Klik Refresh untuk memuat histori...</td></tr></tbody>
      </table>
    </div>
  </section>

    <!-- OTS PANEL -->
    <section id="ots" class="panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px">OTS Tiket</h2>
        <div>
          <button class="btn" onclick="loadOts()">üîÑ Refresh</button>
          <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
      </div>
  
      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Nama</th>
              <th>Jumlah</th>
              <th>Jenis Tiket</th>
              <th>Kode Pesanan</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="otsBody">
            <tr><td colspan="6">Klik Refresh untuk memuat Tiket Ots...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
</main>

<!-- Modal (no auto-close) -->
<div id="resultModal" class="modal">
  <div class="modal-card" id="modalCard">
    <h1 id="modalIcon">‚ùå</h1>
    <h3 id="modalTitle">Judul</h3>
    <p id="modalMessage">Pesan</p>
    <div class="chip" id="modalSub"></div>
    <div class="actions">
      <button class="btn secondary" onclick="closeModal()">Tutup</button>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="sndValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="sndUsed" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="sndInvalid" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>

<script>
/* ==== CONFIG: ganti URL WEBAPP GAS di bawah ==== */
const SHEET_API = "https://script.google.com/macros/s/AKfycby_KZar7ssIv9wK5CRHUe0t-VoKmfgf-ihUHNvjIMH1O2R4zZWQeDDI_ETt2v54fGE/exec"; // contoh: https://script.google.com/macros/s/AKfycbXXXX/exec
/* ============================================== */

/* --- Check Login & Logout -- */
if(localStorage.getItem("panitiaLogin") !== "true"){
  window.location.href = "login.html";
}
function logout(){
  const user = localStorage.getItem("panitiaUser");
  const session = localStorage.getItem("panitiaSession");

  // Panggil back-end untuk membersihkan sesi, tidak perlu menunggu selesai (fire and forget)
  if (user && session) {
    fetch(`${SHEET_API}?action=logout&username=${encodeURIComponent(user)}&sessionID=${encodeURIComponent(session)}`)
      .catch(err => console.error("Logout API call failed:", err));
  }

  // Hapus semua data sesi dari browser
  localStorage.removeItem("panitiaLogin");
  localStorage.removeItem("panitiaUser");
  localStorage.removeItem("panitiaSession");

  // Arahkan ke halaman login
  window.location.href = "login.html";
}
/* -------------------------- */

let qrScanner = null;
const sndValid = document.getElementById('sndValid');
const sndUsed = document.getElementById('sndUsed');
const sndInvalid = document.getElementById('sndInvalid');

/* ---------- Page switching ---------- */
function showPage(page){
  document.getElementById('scanner').style.display = page==='scanner' ? 'block' : 'none';
  document.getElementById('history').style.display = page==='history' ? 'block' : 'none';
  document.getElementById('ots').style.display = page==='ots' ? 'block' : 'none';
  document.getElementById('tabScanner').classList.toggle('active', page==='scanner');
  document.getElementById('tabHistory').classList.toggle('active', page==='history');
  document.getElementById('tabOts').classList.toggle('active', page==='ots');
  if(page==='history') loadHistory();
  if(page==='ots') loadOts();
}
window.showPage = showPage;

/* ---------- Modes ---------- */
function enterCameraMode(){
  document.getElementById('modeSelection').style.display = 'none';
  document.getElementById('cameraArea').style.display = 'block';
  startScanner();
}
function enterManualMode(){
  document.getElementById('modeSelection').style.display = 'none';
  document.getElementById('manualArea').style.display = 'block';
  document.getElementById('manualInput').focus();
}
function backToMode(){
  stopScanner();
  document.getElementById('modeSelection').style.display = 'flex';
  document.getElementById('cameraArea').style.display = 'none';
  document.getElementById('manualArea').style.display = 'none';
  document.getElementById('manualInput').value = '';
}

/* ---------- Scanner (html5-qrcode) ---------- */
async function startScanner(){
  const reader = document.getElementById('reader');
  document.getElementById('procCamera').style.display = 'none';
  qrScanner = new Html5Qrcode("reader");
  try {
    await qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: {width:260,height:260} },
      qrMessage => {
        // saat QR terbaca ‚Üí hentikan scanner, proses
        stopScanner();
        validateCode(qrMessage);
      }
    );
  } catch (err) {
    alert('Gagal akses kamera: ' + err);
    backToMode();
  }
}
function stopScanner(){
  if(qrScanner){
    qrScanner.stop().then(()=>qrScanner.clear()).catch(()=>{});
    qrScanner = null;
  }
}

/* ---------- Manual submit ---------- */
function submitManual(){
  const code = document.getElementById('manualInput').value.trim();
  if(!code) return alert('Masukkan kode tiket!');
  validateCode(code);
}

/* ---------- Validate (call GAS) ---------- */
function validateCode(code){
  // show processing in both modes
  document.getElementById('procCamera').style.display = 'block';
  document.getElementById('procManual').style.display = 'block';

  // call: ?action=validate&code=...
  fetch(`${SHEET_API}?action=validate&code=${encodeURIComponent(code)}`)
    .then(r=>r.json())
    .then(res=>{
      document.getElementById('procCamera').style.display = 'none';
      document.getElementById('procManual').style.display = 'none';

      if(res.status === 'success'){
        playSound('valid');
        showResultModal('success','‚úÖ Check-in Berhasil', `Nama: ${res.data.nama}\nJenis: ${res.data.jenis_tiket}\nOrder: ${res.data.kode_pesanan}`);
      } else if(res.status === 'warning'){
        playSound('used');
        showResultModal('warning','‚ö†Ô∏è Sudah Terpakai', `Nama: ${res.data.nama}\nJenis: ${res.data.jenis_tiket}\nWaktu: ${res.data.waktu_checkin || '-'}`);
      } else {
        playSound('invalid');
        showResultModal('error','‚ùå Gagal', res.message || 'Tiket tidak valid');
      }
    })
    .catch(err=>{
      document.getElementById('procCamera').style.display = 'none';
      document.getElementById('procManual').style.display = 'none';
      playSound('invalid');
      showResultModal('error','‚ùå Error', 'Gagal menghubungkan ke server: ' + err.message);
    });
}

/* ---------- Modal (no auto-close) ---------- */
function showResultModal(type,title,msg){
  const modal = document.getElementById('resultModal');
  const card = document.getElementById('modalCard');
  const icon = document.getElementById('modalIcon');
  const t = document.getElementById('modalTitle');
  const m = document.getElementById('modalMessage');
  const sub = document.getElementById('modalSub');

  t.innerText = title; m.innerText = msg;
  sub.innerText = formatWIB(new Date());
  card.className = 'modal-card';
  if(type==='success'){ icon.innerText='‚úÖ'; card.style.border=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--success') || '#27ae60'}`; }
  else if(type==='warning'){ icon.innerText='‚ö†'; card.style.border=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--warn') || '#f39c12'}`; }
  else { icon.innerText='‚ùå'; card.style.border=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#e74c3c'}`; }

  modal.classList.add('show');
}

/* modal close returns to main mode selection */
function closeModal(){
  const modal = document.getElementById('resultModal');
  modal.classList.remove('show');
  backToMode();
}

/* play sound by type */
function playSound(type){
  try{
    if(type==='valid') sndValid.play();
    else if(type==='used') sndUsed.play();
    else sndInvalid.play();
  }catch(e){}
}

/* Format ke Waktu Indonesia Barat */
function formatWIB(dateString){
  try{
    const date = new Date(dateString);
    const optionsDate = { 
      timeZone: "Asia/Jakarta",
      day: "numeric", month: "long", year: "numeric"
    };
    const optionsTime = { 
      timeZone: "Asia/Jakarta",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      hour12: false 
    };
    const tanggal = new Intl.DateTimeFormat("id-ID", optionsDate).format(date);
    const jam = new Intl.DateTimeFormat("id-ID", optionsTime).format(date).replace(/:/g,".");
    return `${jam} WIB ${tanggal}`;
  } catch(e) {
    return dateString;
  }
}

/* ---------- History Functions ---------- */
function loadHistory() {
  const body = document.getElementById('historyBody');
  body.innerHTML = `<tr><td colspan="5">‚è≥ Memuat histori...</td></tr>`;
  
  fetch(`${SHEET_API}?action=history`)
    .then(r => r.json())
    .then(res => {
      if (res.status === 'success' && res.data && Array.isArray(res.data.records)) {
        const rows = res.data.records;
        if (rows.length === 0) {
          body.innerHTML = `<tr><td colspan="6">Belum ada riwayat</td></tr>`;
          return;
        }
        
        body.innerHTML = rows.reverse().map(r => {
          const statusText = (r['Status'] || '').toLowerCase();
          let statusClass = '';
          if (statusText.includes('berhasil') || statusText.includes('approved')) {
            statusClass = 'status-success';
          } else if (statusText.includes('terpakai') || statusText.includes('rejected')) {
            statusClass = 'status-error';
          } else {
            // Default to warning color for other statuses
            statusClass = 'status-warning';
          }
          
          const qrCode = r['Kode Tiket'] || '';  // Mengambil kode tiket untuk QR
          const jumlahTiket = r['Jumlah Tiket'] || '1';  // Default 1 jika kosong
          
          return `
            <tr>
              <td>${formatWIB(r['Timestamp'] || '')}</td>
              <td>${escapeHtml(r['Nama'] || '')}</td>
              <td class="center">${escapeHtml(jumlahTiket)}</td>
              <td>${escapeHtml(r['Jenis Tiket'] || '')}</td>
              <td class="${statusClass}">${escapeHtml(r['Status'] || '')}</td>
              <td class="center">${qrCode ? `<div style="width: 60px; height: 60px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">${escapeHtml(qrCode)}</div>` : '-'}</td>
              <td>${escapeHtml(r['Kode Pesanan'] || '')}</td>
            </tr>
          `;
        }).join('');
      } else {
        body.innerHTML = `<tr><td colspan="6">Gagal memuat histori</td></tr>`;
      }
    })
    .catch(err => {
      console.error('Error loading history:', err);
      body.innerHTML = `<tr><td colspan="6">Error: ${escapeHtml(err.message)}</td></tr>`;
    });
}

/* ---------- OTS Functions ---------- */
function updateOtsStatus(kodePesanan, action) {
  if (!confirm(`Apakah Anda yakin ingin ${action} tiket ini?`)) return;
  
  fetch(`${SHEET_API}?action=updateOts&kodePesanan=${encodeURIComponent(kodePesanan)}&status=${action}`)
    .then(r => r.json())
    .then(res => {
      if (res.status === 'success') {
        showResultModal('success', 'Berhasil', `Tiket berhasil di${action === 'approve' ? 'setujui' : 'tolak'}`);
        loadOts(); // Refresh the OTS list
      } else {
        showResultModal('error', 'Gagal', res.message || 'Gagal memperbarui status tiket');
      }
    })
    .catch(err => {
      showResultModal('error', 'Error', 'Terjadi kesalahan saat memproses permintaan');
      console.error('Error updating OTS status:', err);
    });
}

function loadOts() {
  const body = document.getElementById('otsBody');
  body.innerHTML = `<tr><td colspan="6">‚è≥ Memuat Tiket OTS...</td></tr>`;
  
  fetch(`${SHEET_API}?action=ots&sheet=TiketOTS`)
    .then(r => r.json())
    .then(res => {
      if (res.status === 'success' && res.data && Array.isArray(res.data.records)) {
        const rows = res.data.records;
        if (rows.length === 0) {
          body.innerHTML = `<tr><td colspan="6">Belum ada tiket OTS</td></tr>`;
          return;
        }
        
        body.innerHTML = rows.reverse().map(r => {
          const status = r['Status'] || '';
          const statusText = status.toLowerCase();
          let statusClass = '';
          
          if (statusText.includes('approved')) {
            statusClass = 'status-success';
          } else if (statusText === 'belum diproses' || statusText === '') {
            statusClass = 'status-warning';
          } else if (statusText.includes('rejected')) {
            statusClass = 'status-error';
          } else {
            // Default to warning for other statuses
            statusClass = 'status-warning';
          }
          
          return `
            <tr>
              <td>${formatWIB(r['Timestamp'] || '')}</td>
              <td>${escapeHtml(r['Nama'] || '')}</td>
              <td>${escapeHtml(r['Jumlah Tiket'] || '')}</td>
              <td>${escapeHtml(r['Jenis Tiket'] || '')}</td>
              <td>${escapeHtml(r['Kode Pesanan'] || '')}</td>
              <td class="${statusClass}">${escapeHtml(r['Status'] || '')}</td>
              <td class="action-buttons">
                <button class="btn-approve" onclick="updateOtsStatus('${escapeHtml(r['Kode Pesanan'] || '')}', 'approve')" ${r['Status'] === 'Approved' || r['Status'] === 'Rejected' ? 'disabled' : ''}>
                  Approve
                </button>
                <button class="btn-reject" onclick="updateOtsStatus('${escapeHtml(r['Kode Pesanan'] || '')}', 'reject')" ${r['Status'] === 'Approved' || r['Status'] === 'Rejected' ? 'disabled' : ''}>
                  Reject
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } else {
        body.innerHTML = `<tr><td colspan="7">Gagal memuat Tiket OTS. ${res.message || ''}</td></tr>`;
      }
    })
    .catch(err => {
      console.error('Error loading OTS:', err);
      body.innerHTML = `<tr><td colspan="6">Error: ${escapeHtml(err.message)}</td></tr>`;
    });
}

/* Export CSV dari histori di front-end */
function exportCSV(){
  fetch(`${SHEET_API}?action=history`).then(r=>r.json()).then(res=>{
    if(!(res.status==='success' && res.data && Array.isArray(res.data.records))){
      return alert('Gagal memuat histori untuk export');
    }
    const rows = res.data.records;
    if(rows.length===0) return alert('Belum ada histori');
    const header = Object.keys(rows[0]);
    const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `histori_checkin_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
  }).catch(e=>alert('Error export: '+e.message));
}

/* Export CSV dari ots di front-end */
function exportCSV(){
  fetch(`${SHEET_API}?action=ots`).then(r=>r.json()).then(res=>{
    if(!(res.status==='success' && res.data && Array.isArray(res.data.records))){
      return alert('Gagal memuat histori untuk export');
    }
    const rows = res.data.records;
    if(rows.length===0) return alert('Belum ada histori');
    const header = Object.keys(rows[0]);
    const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `histori_checkin_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
  }).catch(e=>alert('Error export: '+e.message));
}


/* small helper */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Keyboard: Enter submit manual, ESC close modal */
document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && document.getElementById('manualArea').style.display!=='none'){
    submitManual();
  }
  if(e.key==='Escape' && document.getElementById('resultModal').classList.contains('show')){
    closeModal();
  }
});
</script>
</body>
</html>
