<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Check-in Tiket</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: "Rajdhani", sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
    }
    header {
      background: #222;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 18px; }
    nav button {
      background: #333;
      border: none;
      color: #fff;
      padding: 8px 12px;
      margin-left: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    nav button.active { background: #e50914; }

    main { padding: 20px; }
    .btn {
      background: #e50914;
      border: none;
      color: #fff;
      padding: 10px 16px;
      margin: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { background: #b20710; }
    .hidden { display: none; }

    /* Modal */
    .modal {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      display:none; justify-content:center; align-items:center;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
    }
    .modal-content {
      background:#222; padding:20px; border-radius:10px;
      max-width:400px; text-align:center;
    }
    .modal-content.success { border:2px solid #4caf50; }
    .modal-content.warning { border:2px solid #ff9800; }
    .modal-content.error { border:2px solid #f44336; }

    /* Table */
    table {
      width:100%; border-collapse: collapse; margin-top:10px;
    }
    table th, table td {
      border:1px solid #444; padding:8px; text-align:left;
    }
    table th { background:#222; }
  </style>
</head>
<body>

  <header>
    <h1>üéüÔ∏è Sistem Check-in</h1>
    <nav>
      <button id="tabScanner" class="active" onclick="showPage('scannerPage')">Scanner</button>
      <button id="tabHistory" onclick="showPage('historyPage')">Histori</button>
    </nav>
  </header>

  <main>
    <!-- Scanner Page -->
    <section id="scannerPage">
      <div id="modeSelection">
        <button class="btn" onclick="startScanner()">üì∑ Scan QR Code</button>
        <button class="btn" onclick="showManual()">‚å®Ô∏è Input Kode Manual</button>
      </div>

      <div id="scannerSection" class="hidden">
        <div id="reader" style="width:300px; margin:auto;"></div>
        <button class="btn" onclick="stopScanner()">‚¨Ö Kembali</button>
      </div>

      <div id="manualSection" class="hidden">
        <input type="text" id="manualCode" placeholder="Masukkan ID Tiket" style="padding:10px;width:250px;">
        <br>
        <button class="btn" onclick="submitManual()">‚úÖ Check</button>
        <button class="btn" onclick="backToMenu()">‚¨Ö Kembali</button>
      </div>
    </section>

    <!-- History Page -->
    <section id="historyPage" class="hidden">
      <h2>üìë Histori Check-in</h2>
      <button class="btn" onclick="loadHistory()">üîÑ Refresh</button>
      <table>
        <thead>
          <tr>
            <th>Kode Pesanan</th>
            <th>Nama</th>
            <th>Jenis Tiket</th>
            <th>Waktu Check-in</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          <tr><td colspan="4">Klik refresh untuk memuat data...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- Modal -->
  <div id="resultModal" class="modal">
    <div id="modalContent" class="modal-content">
      <h1 id="modalIcon">‚ùå</h1>
      <h3 id="modalTitle">Judul</h3>
      <p id="modalMessage">Pesan</p>
      <div style="margin-top:15px;">
        <button onclick="closeModal()">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycby_KZar7ssIv9wK5CRHUe0t-VoKmfgf-ihUHNvjIMH1O2R4zZWQeDDI_ETt2v54fGE/exec"; // ganti dengan URL Web App GAS kamu
    let html5QrCode;

    // Suara
    const beepValid = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    const beepUsed = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const beepInvalid = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");

    // Tab Navigation
    function showPage(pageId){
      document.getElementById("scannerPage").classList.add("hidden");
      document.getElementById("historyPage").classList.add("hidden");
      document.getElementById(pageId).classList.remove("hidden");

      document.getElementById("tabScanner").classList.remove("active");
      document.getElementById("tabHistory").classList.remove("active");
      if(pageId==="scannerPage") document.getElementById("tabScanner").classList.add("active");
      else document.getElementById("tabHistory").classList.add("active");

      if(pageId==="historyPage"){ loadHistory(); }
    }

    // Scanner
    function startScanner() {
      document.getElementById("modeSelection").classList.add("hidden");
      document.getElementById("scannerSection").classList.remove("hidden");

      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          stopScanner();
          checkTicket(qrCodeMessage);
        }
      ).catch(err => {
        alert("Gagal akses kamera: " + err);
        backToMenu();
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
      }
      backToMenu();
    }

    function showManual() {
      document.getElementById("modeSelection").classList.add("hidden");
      document.getElementById("manualSection").classList.remove("hidden");
    }

    function submitManual() {
      const code = document.getElementById("manualCode").value.trim();
      if (!code) return alert("Masukkan ID tiket!");
      checkTicket(code);
    }

    function backToMenu() {
      document.getElementById("modeSelection").classList.remove("hidden");
      document.getElementById("scannerSection").classList.add("hidden");
      document.getElementById("manualSection").classList.add("hidden");
    }

    function checkTicket(ticketId) {
      showModal("info","Memproses...","Sedang mengecek tiket ID: " + ticketId);

      fetch(`${SHEET_API}?id=${encodeURIComponent(ticketId)}`)
        .then(res => res.json())
        .then(res => {
          if (res.status === "success") {
            showModal("success", "‚úÖ Tiket Valid", `${res.data.nama} - ${res.data.jenis_tiket}`);
          } else if (res.status === "warning") {
            showModal("warning", "‚ö†Ô∏è Sudah Check-in", `${res.data.nama} - ${res.data.jenis_tiket}`);
          } else {
            showModal("error", "‚ùå Tidak Valid", res.message || "Tiket tidak ditemukan");
          }
        })
        .catch(err => {
          showModal("error", "‚ùå Error", err.message);
        });
    }

    function showModal(type, title, message){
      const modal=document.getElementById("resultModal");
      const content=document.getElementById("modalContent");
      const icon=document.getElementById("modalIcon");
      const modalTitle=document.getElementById("modalTitle");
      const modalMessage=document.getElementById("modalMessage");

      modalTitle.innerText=title;
      modalMessage.innerText=message;
      content.className="modal-content";

      if(type==="success"){ content.classList.add("success"); icon.innerText="‚úÖ"; beepValid.play();}
      else if(type==="warning"){ content.classList.add("warning"); icon.innerText="‚ö†"; beepUsed.play();}
      else if(type==="error"){ content.classList.add("error"); icon.innerText="‚ùå"; beepInvalid.play();}
      else { icon.innerText="‚è≥"; }

      modal.style.display="flex";
    }

    function closeModal(){
      document.getElementById("resultModal").style.display="none";
      backToMenu();
    }

    // Load History
    function loadHistory(){
      const tbody=document.getElementById("historyTable");
      tbody.innerHTML="<tr><td colspan='4'>‚è≥ Memuat data...</td></tr>";

      fetch(`${SHEET_API}?history=1`)
        .then(res=>res.json())
        .then(res=>{
          if(res.status==="success" && Array.isArray(res.data)){
            if(res.data.length===0){
              tbody.innerHTML="<tr><td colspan='4'>Belum ada check-in</td></tr>";
              return;
            }
            tbody.innerHTML=res.data.map(row=>`
              <tr>
                <td>${row.kode_pesanan}</td>
                <td>${row.nama}</td>
                <td>${row.jenis_tiket}</td>
                <td>${row.waktu_checkin}</td>
              </tr>`).join("");
          } else {
            tbody.innerHTML="<tr><td colspan='4'>Gagal memuat data</td></tr>";
          }
        })
        .catch(err=>{
          tbody.innerHTML="<tr><td colspan='4'>Error: "+err.message+"</td></tr>";
        });
    }
  </script>
</body>
</html>
