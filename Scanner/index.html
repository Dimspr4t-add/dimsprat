<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Tiket Profesional</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { margin:0; padding:0; font-family:'Rajdhani', sans-serif; background:#121212; color:#fff; text-align:center;}
h2 { margin:20px 0; color:#00bfff; }

#reader { width:320px; margin:30px auto;}
#processing { display:none; margin-top:15px; font-weight:bold; color:#00f;}

.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); justify-content:center; align-items:center; }
.modal-content { background:#1e1e1e; padding:30px 20px; border-radius:15px; width:90%; max-width:400px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.7); position:relative; animation:fadeIn 0.3s ease; }
.modal h1 { font-size:3rem; margin:0; }
.modal h3 { margin:10px 0; font-size:1.5rem; }
.modal p { margin:10px 0; line-height:1.5; color:#ddd; white-space:pre-line; }
.modal button { margin-top:15px; padding:10px 25px; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:0.2s; font-family:'Orbitron', sans-serif; }
.modal button:hover { opacity:0.9; }

.success h1 { color:#0f0; }
.success h3 { color:#0f0; }
.success button { background:#0f0; color:#000; }

.warning h1 { color:#ffa500; }
.warning h3 { color:#ffa500; }
.warning button { background:#ffa500; color:#000; }

.error h1 { color:#f00; }
.error h3 { color:#f00; }
.error button { background:#f00; color:#fff; }

@keyframes fadeIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

#countdown { font-size:0.9rem; margin-top:5px; color:#ccc; }

</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h2>üì∑ Scanner Tiket Check-In Profesional</h2>
<div id="reader"></div>
<div id="processing">üîÑ Memproses...</div>

<!-- Modal -->
<div id="resultModal" class="modal">
  <div id="modalContent" class="modal-content">
    <h1 id="modalIcon">‚ùå</h1>
    <h3 id="modalTitle">Judul</h3>
    <p id="modalMessage">Pesan</p>
    <div id="countdown"></div>
    <div style="margin-top:15px;">
      <button onclick="closeModal()">Tutup</button>
      <button onclick="bypassClose()" style="margin-left:10px;">Scan Lanjut</button>
    </div>
  </div>
</div>

<!-- Suara -->
<audio id="beepValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="beepInvalid" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
<audio id="beepUsed" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
const SHEET_API = "https://script.google.com/macros/s/AKfycby_KZar7ssIv9wK5CRHUe0t-VoKmfgf-ihUHNvjIMH1O2R4zZWQeDDI_ETt2v54fGE/exec"; // Ganti GAS Web App

const beepValid = document.getElementById("beepValid");
const beepInvalid = document.getElementById("beepInvalid");
const beepUsed = document.getElementById("beepUsed");

let modalTimer;
let autoCloseEnabled = true;

function showModal(type, title, message) {
  const modal = document.getElementById("resultModal");
  const content = document.getElementById("modalContent");
  const icon = document.getElementById("modalIcon");
  const modalTitle = document.getElementById("modalTitle");
  const modalMessage = document.getElementById("modalMessage");
  const countdown = document.getElementById("countdown");

  modalTitle.innerText = title;
  modalMessage.innerText = message;

  content.className = "modal-content"; // reset
  countdown.innerText = "";

  if(type==="success"){ content.classList.add("success"); icon.innerText="‚úÖ"; beepValid.play();}
  else if(type==="warning"){ content.classList.add("warning"); icon.innerText="‚ö†"; beepUsed.play();}
  else{ content.classList.add("error"); icon.innerText="‚ùå"; beepInvalid.play(); }

  modal.style.display="flex";

  // Auto-close modal 3 detik (hanya jika tidak di-bypass)
  if(autoCloseEnabled){
    let timeLeft=3;
    countdown.innerText=`Menutup dalam ${timeLeft} detik...`;
    clearInterval(modalTimer);
    modalTimer=setInterval(()=>{
      timeLeft--;
      if(timeLeft>0) countdown.innerText=`Menutup dalam ${timeLeft} detik...`;
      else closeModal();
    },1000);
  }
}

function bypassClose(){
  clearInterval(modalTimer);
  document.getElementById("countdown").innerText = "Auto-close dibypass, tekan 'Tutup' untuk lanjut.";
  autoCloseEnabled = false;
}

function closeModal(){
  clearInterval(modalTimer);
  document.getElementById("resultModal").style.display="none";
  autoCloseEnabled = true; // Reset untuk scan berikutnya
}

function updateProcessing(show){ document.getElementById("processing").style.display = show ? "block" : "none"; }

function onScanSuccess(decodedText, decodedResult){
  updateProcessing(true);
  fetch(`${SHEET_API}?code=${encodeURIComponent(decodedText)}`)
    .then(res=>res.json())
    .then(data=>{
      updateProcessing(false);
      if(data.valid) showModal("success","Tiket Valid", `Nama: ${data.nama}\nTiket: ${data.ticket||'-'}`);
      else if(data.message && data.message.includes("dipakai")) showModal("warning","Tiket Sudah Terpakai", data.message);
      else showModal("error","Tiket Tidak Valid", data.message||"Kode tidak ditemukan");
    })
    .catch(err=>{
      updateProcessing(false);
      showModal("error","Error","Gagal menghubungkan ke server");
    });
}

const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},onScanSuccess)
.catch(err=>{ updateProcessing(false); showModal("error","Kamera Tidak Bisa Diakses","Pastikan perangkat memiliki kamera dan izinkan akses."); });
</script>

</body>
</html>
