<script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        // =======================================================================
        // URL WEB APP GOOGLE APPS SCRIPT ANDA
        // =======================================================================
        const googleAppScriptURL = 'https://script.google.com/macros/s/AKfycbzANeVqUwGAImpQ5_DCRyHW0tU8KUhGRaiI6dROVPeGupJuG0pWP7oUh1uFXCFc6kJd/exec'; 
        
        let html5QrcodeScanner = null; 
        const readerId = "reader";

        // Fungsi Navigasi
        window.showTab = (tabId) => {
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            const navItem = document.querySelector(`.nav-item[onclick="showTab('${tabId}')"]`);
            if(navItem) navItem.classList.add('active');
            
            // Logika memulai/menghentikan scanner
            if (tabId === 'scan-qr') {
                startScanner();
            } else {
                stopScanner();
            }
            
            if (tabId !== 'add-guest') {
                document.getElementById('result-area').style.display = 'none';
            }
        };

        // --- SCANNER LOGIC (Minimal UI & Notifikasi Terstruktur) ---

        function startScanner() {
            const scanResultDiv = document.getElementById('scan-result');
            
            if (!html5QrcodeScanner) {
                // Menggunakan Html5Qrcode dasar untuk kontrol UI manual
                html5QrcodeScanner = new Html5Qrcode(readerId);
            }
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
            };

            // Memulai pemindaian secara manual (menghindari UI default)
            html5QrcodeScanner.start(
                { facingMode: { exact: "environment" } }, // Kamera belakang
                config,
                onScanSuccess,
                (errorMessage) => { /* ignore continuous error */ }
            ).catch(err => {
                console.error("Gagal memulai scanner (Cek izin kamera atau ketersediaan):", err);
                scanResultDiv.innerHTML = `<span style="color:var(--primary); font-weight:bold;">❌ Gagal membuka kamera. Cek izin browser.</span>`;
            });
            
            scanResultDiv.textContent = 'Siap memindai QR Code...';
        }

        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().catch(err => {
                    console.log("Error stopping scanner (may be safe to ignore): ", err);
                });
                html5QrcodeScanner = null; // Reset
            }
        }
        
        async function onScanSuccess(decodedText, decodedResult) {
            stopScanner(); 
            
            const scanResultDiv = document.getElementById('scan-result');
            scanResultDiv.textContent = `Memproses Kode: ${decodedText}...`;
            
            await sendCheckInRequest(decodedText);
            
            // Lanjutkan pemindaian setelah jeda 3 detik
            setTimeout(startScanner, 3000); 
        }

        // Mengirim Kode Unik ke Apps Script (Logika Check-in)
        async function sendCheckInRequest(code) {
            const scanResultDiv = document.getElementById('scan-result');
            try {
                const response = await fetch(googleAppScriptURL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=checkIn&code=${encodeURIComponent(code)}`
                });

                const data = await response.json();
                
                const isSuccess = data.status === 'success';
                const resultColor = isSuccess ? '#4CAF50' : 'var(--primary)';
                const resultIcon = isSuccess ? '✅' : '❌';

                let htmlContent = `<span style="color:${resultColor}; font-weight:bold;">${resultIcon} ${data.message}</span>`;
                
                // --- STRUKTUR NOTIFIKASI TAMBAHAN ---
                if (data.name && data.kode) {
                    htmlContent += `
                        <div style="text-align:left; margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                            <p style="margin:2px 0; font-size:0.9rem;">Nama: <b style="color:var(--text-white);">${data.name}</b></p>
                            <p style="margin:2px 0; font-size:0.9rem;">QR ID: <b style="color:var(--text-white);">${data.kode}</b></p>
                            <p style="margin:2px 0; font-size:0.9rem;">Status: <b style="color:${isSuccess ? '#4CAF50' : 'orange'};">${data.statusText || 'Gagal'}</b></p>
                            <p style="margin:2px 0; font-size:0.8rem; color:var(--text-muted); border-top:1px dashed rgba(255,255,255,0.1); padding-top:5px; margin-top:5px;">Waktu: ${data.time || '-'}</p>
                        </div>
                    `;
                }
                
                scanResultDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error("Check-in Error:", error);
                scanResultDiv.innerHTML = '<span style="color:var(--primary); font-weight:bold;">❌ Error Jaringan/Skrip.</span><p style="margin-top:5px; font-size:0.8rem;">Cek koneksi internet Anda.</p>';
            }
        }

        // --- INPUT GUEST LOGIC (TIDAK BERUBAH) ---

        document.addEventListener('DOMContentLoaded', () => {
            const generateLinkBtn = document.getElementById('generateLinkBtn');
            const namaTamuInput = document.getElementById('namaTamu');
            const resultArea = document.getElementById('result-area');
            const resultMsg = document.getElementById('result-msg');
            const resultLinkInput = document.getElementById('result-link');
            const copyLinkBtn = document.getElementById('copyLinkBtn');

            resultArea.style.display = 'none';

            // Aksi Generate Link (Kirim ke Apps Script)
            generateLinkBtn.addEventListener('click', async () => {
                const namaTamu = namaTamuInput.value.trim();

                if (namaTamu === "") {
                    alert("Nama Tamu tidak boleh kosong!");
                    return;
                }

                generateLinkBtn.disabled = true;
                generateLinkBtn.textContent = 'Memproses... Harap Tunggu...';
                resultArea.style.display = 'none';
                resultLinkInput.value = 'Memproses...';

                try {
                    const response = await fetch(googleAppScriptURL, {
                        method: 'POST',
                        mode: 'cors', 
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=addGuest&namaTamu=${encodeURIComponent(namaTamu)}`
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        resultMsg.innerHTML = `✅ Link berhasil dibuat: <b>${data.nama}</b> (Kode: ${data.kode})`;
                        resultLinkInput.value = data.link;
                        resultArea.style.display = 'block';
                        copyLinkBtn.dataset.link = data.link;
                        
                        namaTamuInput.value = ''; 
                        namaTamuInput.focus(); 

                    } else {
                        resultMsg.textContent = `❌ Gagal: ${data.message || 'Terjadi kesalahan pada skrip Apps Script.'}`;
                        resultLinkInput.value = '';
                        resultArea.style.display = 'block';
                    }

                } catch (error) {
                    console.error("Fetch Error:", error);
                    resultMsg.textContent = '❌ Terjadi kesalahan jaringan atau CORS.';
                    resultLinkInput.value = '';
                    resultArea.style.display = 'block';

                } finally {
                    generateLinkBtn.disabled = false;
                    generateLinkBtn.textContent = 'Generate Link';
                }
            });
            
            // Aksi Salin Link
            copyLinkBtn.addEventListener('click', () => {
                const linkToCopy = resultLinkInput.value.trim();
                
                if (!linkToCopy || linkToCopy.includes('Memproses') || linkToCopy.includes('akan muncul')) {
                    alert("Silakan Generate link undangan terlebih dahulu.");
                    return;
                }
                
                navigator.clipboard.writeText(linkToCopy)
                    .then(() => {
                        alert(`Link undangan berhasil disalin: ${linkToCopy}`);
                    })
                    .catch(err => {
                        console.error('Gagal menyalin:', err);
                        alert('Gagal menyalin. Mohon salin teks link manual.');
                    });
            });

            // Inisialisasi: Pastikan tab 'add-guest' yang aktif
            showTab('add-guest');
        });
    </script>
</body>
</html>
