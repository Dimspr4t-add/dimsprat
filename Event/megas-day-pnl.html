<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Mega's Day</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* --- RED THEME VARIABLES --- */
        :root {
            --primary: #ff0033;
            --primary-dark: #b30024;
            --text-white: #ffffff;
            --text-muted: #b0b0b0;

            --glass-bg: rgba(20, 20, 20, 0.70);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.7);
            --blur-amt: 12px;

            --header-h: 70px;
            --nav-h: 70px;
            --z-header: 1000;
            --z-nav: 1000;
            --z-bg: -1;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-white);
            margin: 0;
            padding: 0;
            padding-top: calc(var(--header-h) + 25px);
            padding-bottom: calc(var(--nav-h) + 30px);
            min-height: 100vh;
            background-color: var(--bg-dark);
            position: relative;
        }

        /* BACKGROUND BLUR IMPLEMENTATION */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-bg);
            background: url('https://www.dimsprat.site/Assets/images/Background.webp') no-repeat center center;
            background-size: cover;
            filter: blur(3px) brightness(0.4);
            transform: scale(1.05);
            pointer-events: none;
        }

        /* --- 1. HEADER (Fixed Glass) --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-h);
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: var(--z-header);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .header-logo-img {
            height: 38px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        /* --- 2. CONTAINER & CARD --- */
        .container {
            padding: 0 20px;
            max-width: 480px;
            margin: 0 auto;
            display: none;
            animation: fadeInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }

        .container.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amt));
            -webkit-backdrop-filter: blur(var(--blur-amt));
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px 25px;
            box-shadow: var(--glass-shadow);
            text-align: center;
        }

        h2 {
            margin: 0 0 25px 0;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding-bottom: 15px;
        }

        /* --- 3. FORMS & BUTTONS --- */
        .input-wrapper {
            margin-bottom: 25px;
        }

        input[type="text"] {
            width: 100%;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-white);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 0, 51, 0.3);
            background: rgba(0, 0, 0, 0.7);
        }

        button {
            width: 100%;
            padding: 16px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-white);
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 0, 51, 0.25);
            font-family: 'Poppins', sans-serif;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        
        button:disabled {
            background: #444 !important;
            box-shadow: none !important;
            cursor: not-allowed;
        }

        button:active {
            transform: scale(0.97);
        }

        button:hover {
            box-shadow: 0 10px 25px rgba(255, 0, 51, 0.4);
        }

        /* Result Area */
        #result-area {
            margin-top: 25px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 0, 51, 0.3);
            display: none;
        }

        .link-display {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 0.85rem;
            text-align: center;
            margin: 10px 0;
            font-family: monospace;
            font-weight: bold;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: none !important;
            margin-top: 10px;
            font-size: 0.85rem !important;
            padding: 12px !important;
            color: var(--text-muted) !important;
        }

        .btn-secondary:hover {
            color: var(--text-white) !important;
            border-color: var(--text-white) !important;
        }

        /* --- 4. SCANNER UI --- */
        #reader {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #333;
            background: #000;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        #scan-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
        }

        /* --- 5. HISTORY LIST --- */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 12px;
            background: rgba(30, 30, 30, 0.6);
            border-radius: 12px;
            border-left: 4px solid #444;
            transition: transform 0.2s, background 0.2s;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: rgba(40, 40, 40, 0.8);
        }

        .history-item.success {
            border-left-color: #4caf50;
        }

        .history-item.fail {
            border-left-color: var(--primary);
        }

        .h-info {
            text-align: left;
        }

        .h-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-white);
            display: block;
            margin-bottom: 4px;
        }

        .h-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .h-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }
        
        .history-stats p {
            margin: 5px 0;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .history-stats .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            margin-left: 5px;
        }

        /* --- 6. FLOATING NAVIGATION --- */
        .nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 360px;
            height: var(--nav-h);
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 35px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            border: 1px solid rgba(255, 0, 51, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            z-index: var(--z-nav);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            width: 70px;
            height: 100%;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-text {
            font-size: 0.65rem;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            position: absolute;
            bottom: 12px;
            color: var(--primary);
            letter-spacing: 1px;
        }

        /* Active State */
        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            transform: translateY(-10px) scale(1.1);
            filter: drop-shadow(0 0 8px var(--primary));
        }

        .nav-item.active .nav-text {
            opacity: 1;
            transform: translateY(0);
        }

        /* Red Dot Indicator */
        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 15px;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--primary);
        }
    </style>
</head>

<body>

    <header class="app-header">
        <img src="https://www.dimsprat.site/Assets/images/logo.png" alt="Dimsprat" class="header-logo-img">
    </header>

    <div id="add-guest" class="container active">
        <div class="card">
            <h2>Buat Undangan Baru</h2>
            <div class="input-wrapper">
                <input type="text" id="namaTamu" placeholder="Ketik Nama Tamu..." autocomplete="off">
            </div>
            <button id="generateLinkBtn">Generate Link</button>

            <div id="result-area">
                <div id="result-msg" style="font-size:0.9rem; margin-bottom:15px; font-weight:600;"></div>
                <input type="text" id="result-link" class="link-display" readonly onclick="this.select()" value="Link akan muncul setelah proses...">
                <button id="copyLinkBtn" class="btn-secondary">Salin Link</button>
            </div>
        </div>
    </div>

    <div id="scan-qr" class="container">
        <div class="card">
            <h2>Scan Check-in</h2>
            <div id="reader"></div>
            <div id="scan-result">Siap memindai QR Code...</div>
        </div>
    </div>

    <div id="history" class="container">
        <div class="history-header">
            <h2 style="margin:0; border:none; padding:0; color:#fff; font-size:1.2rem;">Live History</h2>
            <button id="refreshHistoryBtn" class="btn-secondary" style="width:auto !important; padding:10px 20px !important; margin:0 !important;">Refresh</button>
        </div>
        
        <div id="history-stats" class="card history-stats" style="padding:15px; margin-bottom: 20px;">
            <p>Total Tamu: <span id="totalGuests" class="stat-value" style="color:#fff;">0</span></p>
            <p>Sudah Hadir: <span id="hadirCount" class="stat-value" style="color:#4CAF50;">0</span></p>
            <p>Belum Hadir: <span id="belumHadirCount" class="stat-value" style="color:var(--primary);">0</span></p>
        </div>

        <div id="history-list">
            <div style="text-align:center; color:#666; margin-top:30px; font-style:italic;">Tekan Refresh untuk memuat data...</div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="showTab('add-guest')">
            <div class="nav-icon">‚ú®</div>
            <div class="nav-text">Input</div>
        </div>
        <div class="nav-item" onclick="showTab('scan-qr')">
            <div class="nav-icon">üì∑</div>
            <div class="nav-text">Scan</div>
        </div>
        <div class="nav-item" onclick="showTab('history')">
            <div class="nav-icon">üìú</div>
            <div class="nav-text">History</div>
        </div>
    </nav>

// =======================================================================
// KODE JAVASCRIPT UNTUK megas-day-pnl.html (MODIFIKASI SCANNER)
// =======================================================================
<script>
    // URL Apps Script Anda
    const googleAppScriptURL = 'https://script.google.com/macros/s/AKfycbzANeVqUwGAImpQ5_DCRyHW0tU8KUhGRaiI6dROVPeGupJuG0pWP7oUh1uFXCFc6kJd/exec'; 
    
    let html5QrcodeScanner = null; 
    const readerId = "reader";
    let isScannerActive = false; // Flag untuk melacak status scanner

    // Fungsi Navigasi (tetap sama)
    window.showTab = (tabId) => {
        document.querySelectorAll('.container').forEach(container => {
            container.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(navItem => {
            navItem.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        const navItem = document.querySelector(`.nav-item[onclick="showTab('${tabId}')"]`);
        if(navItem) navItem.classList.add('active');
        
        // Logika memulai/menghentikan scanner
        if (tabId === 'scan-qr') {
            startScanner();
        } else {
            stopScanner();
        }
        
        if (tabId === 'history') {
            loadHistory();
        }

        if (tabId !== 'add-guest') {
            document.getElementById('result-area').style.display = 'none';
        }
    };

    // --- SCANNER LOGIC ---

    function startScanner() {
        const scanResultDiv = document.getElementById('scan-result');
        
        if (isScannerActive) return;

        if (!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5Qrcode(readerId);
        }
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
        };

        html5QrcodeScanner.start(
            { facingMode: { exact: "environment" } }, // Kamera belakang
            config,
            onScanSuccess,
            (errorMessage) => { /* ignore continuous error */ }
        ).then(() => {
            isScannerActive = true;
            scanResultDiv.textContent = 'Siap memindai QR Code...';
        }).catch(err => {
            console.error("Gagal memulai scanner:", err);
            scanResultDiv.innerHTML = `<span style="color:var(--primary); font-weight:bold;">‚ùå Gagal membuka kamera. Cek izin browser.</span>`;
        });
    }

    function stopScanner() {
        if (html5QrcodeScanner && isScannerActive) {
            html5QrcodeScanner.stop().catch(err => {
                console.log("Error stopping scanner: ", err);
            });
            html5QrcodeScanner = null; 
            isScannerActive = false;
        }
    }
    
    // Fungsi baru untuk menutup notifikasi dan memulai ulang scanner
    window.resetScannerAndStart = () => {
        // Hapus notifikasi
        document.getElementById('scan-result').innerHTML = 'Siap memindai QR Code...'; 
        // Mulai scanner
        startScanner();
    }

    async function onScanSuccess(decodedText, decodedResult) {
        // HENTIKAN SCANNER, JANGAN DIBUAT OTOMATIS MULAI LAGI
        stopScanner(); 
        
        const scanResultDiv = document.getElementById('scan-result');
        scanResultDiv.textContent = `Memproses Kode: ${decodedText}...`;
        
        await sendCheckInRequest(decodedText);
        
        // CATATAN: Tidak ada setTimeout di sini. Tombol "Lanjut Scan" akan dipanggil dari sendCheckInRequest.
    }

    // Mengirim Kode Unik ke Apps Script (Logika Check-in)
    async function sendCheckInRequest(code) {
        const scanResultDiv = document.getElementById('scan-result');
        try {
            const response = await fetch(googleAppScriptURL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=checkIn&code=${encodeURIComponent(code)}`
            });

            const data = await response.json();
            
            const isSuccess = data.status === 'success';
            const resultColor = isSuccess ? '#4CAF50' : 'var(--primary)';
            const resultIcon = isSuccess ? '‚úÖ' : '‚ùå';

            let htmlContent = `<span style="color:${resultColor}; font-weight:bold;">${resultIcon} ${data.message}</span>`;
            
            // --- STRUKTUR NOTIFIKASI TAMBAHAN ---
            if (data.name && data.kode) {
                const statusColor = isSuccess ? '#4CAF50' : (data.statusText === 'HADIR' ? 'orange' : 'var(--primary)');
                const isRegistered = data.name !== "TIDAK TERDAFTAR";

                htmlContent += `
                    <div style="text-align:left; margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                        <p style="margin:2px 0; font-size:0.9rem;">Nama: <b style="color:var(--text-white);">${data.name}</b></p>
                        <p style="margin:2px 0; font-size:0.9rem;">QR ID: <b style="color:var(--text-white);">${data.kode}</b></p>
                        ${isRegistered ? `
                            <p style="margin:2px 0; font-size:0.9rem;">Status: <b style="color:${statusColor};">${data.statusText || 'Gagal'}</b></p>
                            <p style="margin:2px 0; font-size:0.8rem; color:var(--text-muted); border-top:1px dashed rgba(255,255,255,0.1); padding-top:5px; margin-top:5px;">Waktu: ${data.time || '-'}</p>
                        ` : `<p style="margin:5px 0; color:var(--primary); font-size:0.8rem;">Kode tidak terdaftar dalam sistem.</p>`}
                    </div>
                `;
            } else if (data.status === 'fail' && data.kode) {
                 htmlContent += `<p style="margin-top:10px; font-size:0.9rem;">Kode ${data.kode} tidak terdaftar.</p>`;
            }
            
            // --- TAMBAHKAN TOMBOL TUTUP MANUAL ---
            htmlContent += `
                <button onclick="resetScannerAndStart()" style="margin-top: 20px; width: 80%; background: #4CAF50; color: white;">
                    Lanjut Scan
                </button>
            `;
            
            scanResultDiv.innerHTML = htmlContent;

        } catch (error) {
            console.error("Check-in Error:", error);
            scanResultDiv.innerHTML = '<span style="color:var(--primary); font-weight:bold;">‚ùå Error Jaringan/Skrip.</span><p style="margin-top:5px; font-size:0.8rem;">Cek koneksi internet Anda.</p>';
        }
    }

    // --- HISTORY LOGIC (tetap sama) ---
    
    document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);

    async function loadHistory() {
        const listDiv = document.getElementById('history-list');
        const statsDiv = document.getElementById('history-stats');
        listDiv.innerHTML = '<div style="text-align:center; color:#666; margin-top:30px; font-style:italic;">Memuat data...</div>';
        
        try {
            const response = await fetch(googleAppScriptURL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=getHistory`
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Update Statistik
                document.getElementById('totalGuests').textContent = data.total;
                document.getElementById('hadirCount').textContent = data.hadir;
                document.getElementById('belumHadirCount').textContent = data.belumHadir;

                // Buat Daftar History
                listDiv.innerHTML = '';
                if (data.history.length === 0) {
                    listDiv.innerHTML = '<div style="text-align:center; color:#666; margin-top:30px; font-style:italic;">Belum ada tamu yang terdaftar.</div>';
                    return;
                }

                data.history.forEach(item => {
                    const isHadir = item.status === 'HADIR';
                    const itemClass = item.rowClass; 
                    const badgeText = isHadir ? 'HADIR' : 'BELUM HADIR';
                    const timeText = isHadir ? item.time : '';

                    const itemHtml = `
                        <div class="history-item ${itemClass}">
                            <div class="h-info">
                                <span class="h-name">${item.name}</span>
                                <span class="h-time">${timeText}</span>
                            </div>
                            <div class="h-badge" style="background:${isHadir ? '#2e7d32' : 'var(--primary)'}; color:#fff;">${badgeText}</div>
                        </div>
                    `;
                    listDiv.innerHTML += itemHtml;
                });

            } else {
                listDiv.innerHTML = `<div style="text-align:center; color:var(--primary); margin-top:30px; font-weight:bold;">‚ùå Gagal memuat data history: ${data.message}</div>`;
            }

        } catch (error) {
            listDiv.innerHTML = `<div style="text-align:center; color:var(--primary); margin-top:30px; font-weight:bold;">‚ùå Error Jaringan saat memuat History.</div>`;
        }
    }


    // --- INPUT GUEST LOGIC (tetap sama) ---

    document.addEventListener('DOMContentLoaded', () => {
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        const namaTamuInput = document.getElementById('namaTamu');
        const resultArea = document.getElementById('result-area');
        const resultMsg = document.getElementById('result-msg');
        const resultLinkInput = document.getElementById('result-link');
        const copyLinkBtn = document.getElementById('copyLinkBtn');

        resultArea.style.display = 'none';

        // Aksi Generate Link (Kirim ke Apps Script)
        generateLinkBtn.addEventListener('click', async () => {
            const namaTamu = namaTamuInput.value.trim();

            if (namaTamu === "") {
                alert("Nama Tamu tidak boleh kosong!");
                return;
            }

            generateLinkBtn.disabled = true;
            generateLinkBtn.textContent = 'Memproses... Harap Tunggu...';
            resultArea.style.display = 'none';
            resultLinkInput.value = 'Memproses...';

            try {
                const response = await fetch(googleAppScriptURL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=addGuest&namaTamu=${encodeURIComponent(namaTamu)}`
                });

                const data = await response.json();

                if (data.status === 'success') {
                    resultMsg.innerHTML = `‚úÖ Link berhasil dibuat: <b>${data.nama}</b> (Kode: ${data.kode})`;
                    resultLinkInput.value = data.link;
                    resultArea.style.display = 'block';
                    copyLinkBtn.dataset.link = data.link;
                    
                    namaTamuInput.value = ''; 
                    namaTamuInput.focus(); 

                } else {
                    resultMsg.textContent = `‚ùå Gagal: ${data.message || 'Terjadi kesalahan pada skrip Apps Script.'}`;
                    resultLinkInput.value = '';
                    resultArea.style.display = 'block';
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                resultMsg.textContent = '‚ùå Terjadi kesalahan jaringan atau CORS.';
                resultLinkInput.value = '';
                resultArea.style.display = 'block';

            } finally {
                generateLinkBtn.disabled = false;
                generateLinkBtn.textContent = 'Generate Link';
            }
        });
        
        // Aksi Salin Link
        copyLinkBtn.addEventListener('click', () => {
            const linkToCopy = resultLinkInput.value.trim();
            
            if (!linkToCopy || linkToCopy.includes('Memproses') || linkToCopy.includes('akan muncul')) {
                alert("Silakan Generate link undangan terlebih dahulu.");
                return;
            }
            
            navigator.clipboard.writeText(linkToCopy)
                .then(() => {
                    alert(`Link undangan berhasil disalin: ${linkToCopy}`);
                })
                .catch(err => {
                    console.error('Gagal menyalin:', err);
                    alert('Gagal menyalin. Mohon salin teks link manual.');
                });
        });

        // Inisialisasi: Pastikan tab 'add-guest' yang aktif
        showTab('add-guest');
    });
</script>
</body>
</html>
