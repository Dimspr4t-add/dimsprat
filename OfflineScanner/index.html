<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dimsprat Scanner</title>
  <link rel="icon" type="image/x-icon" href="../Assets/images/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Assets/style.css">
  <link rel="stylesheet" href="../Assets/js.css">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* Global Styles */
  :root {
    --primary: #e63946;
    --secondary: #1d3557;
    --accent: #ff4d4d;
    --success: #27ae60;
    --warn: #f39c12;
    --danger: #e74c3c;
    --text: #f8f9fa;
    --muted: #adb5bd;
    --bg-dark: #0f172a;
    --bg-darker: #0b1120;
    --border: rgba(255, 255, 255, 0.1);
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Rajdhani', sans-serif;
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }
  
  /* Header Styles */
  #header {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    transition: all 0.3s ease;
  }
  
  .header-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 10px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
  }
  
  .logo-img {
    height: 40px;
    width: auto;
    max-width: 180px;
    object-fit: contain;
    transition: transform 0.3s ease, opacity 0.2s ease;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  }
  
  .logo-img:hover {
    transform: scale(1.03);
  }
  
  /* Navigation */
  nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
  }
  
  nav button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #fff;
    padding: 8px 18px;
    border-radius: 50px;
    cursor: pointer;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 15px;
    white-space: nowrap;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  nav button i {
    font-size: 1.1em;
  }
  
  nav button:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
  }
  
  nav button:active {
    transform: translateY(0);
  }
  
  nav button.active {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 4px 15px rgba(255, 45, 45, 0.2);
  }
  
  #btnLogout {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
    border-color: rgba(255, 107, 107, 0.2);
  }
  
  #btnLogout:hover {
    background: rgba(255, 107, 107, 0.2);
  }

  /* Main content */
  main {
    flex: 1;
    padding: 30px 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .panel {
    background: rgba(30, 41, 59, 0.6);
    padding: 30px;
    border-radius: 20px;
    min-width: 320px;
    max-width: 100%;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), #ff9f43);
    opacity: 0.8;
  }
  
  .panel:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }
  .center {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    text-align: center;
  }

  /* Mode selection */
  .mode-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 20px 0;
  }
  
  .btn {
    background: var(--accent);
    border: none;
    padding: 12px 28px;
    border-radius: 50px;
    color: #fff;
    cursor: pointer;
    font-weight: 700;
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    letter-spacing: 0.5px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 150px;
    position: relative;
    overflow: hidden;
    z-index: 1;
  }
  
  .btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
  }
  
  .btn:hover::after {
    opacity: 1;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 45, 45, 0.3);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn.secondary {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text);
  }
  
  .btn.secondary:hover {
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    color: var(--muted);
  }
  
  .btn.ghost:hover {
    background: rgba(255, 255, 255, 0.03);
    border-color: var(--accent);
    color: #fff;
  }

  /* Scanner area */
  #reader {width:320px;margin:0 auto}
  .processing{display:flex;align-items:center;gap:10px;color:var(--muted);margin-top:8px}
  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.8));backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:999}
  .modal.show{display:flex}
  .modal-card{background:linear-gradient(180deg,#0f1214,#151617);padding:22px;border-radius:14px;min-width:300px;max-width:420px;text-align:center;box-shadow:0 14px 38px rgba(0,0,0,0.6)}
  .modal-card h1{font-size:48px;margin:0}
  .modal-card h3{margin:12px 0 8px;font-size:20px}
  .modal-card p{margin:0;color:var(--muted);white-space:pre-line}
  .modal-card .actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:13px;margin-top:10px}

  /* Table (history) */
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:var(--muted);font-weight:600;font-size:13px}
  tbody tr:hover td{background:rgba(255,255,255,0.01)}

  /* Form Elements */
  input[type="text"],
  input[type="number"],
  input[type="email"],
  input[type="password"],
  select,
  textarea {
    width: 100%;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.7);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    transition: all 0.2s ease;
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 77, 77, 0.2);
  }
  
  /* Table Styling */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 20px 0;
    font-size: 14px;
    border-radius: 12px;
    overflow: hidden;
  }
  
  th, td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  th {
    background: rgba(255, 255, 255, 0.03);
    color: var(--muted);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
  }
  
  tbody tr {
    transition: background-color 0.2s ease;
  }
  
  tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
  }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .header-container {
      padding: 10px 16px;
    }
    
    nav {
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    
    .panel {
      padding: 20px;
    }
  }
  
  @media (max-width: 992px) {
    .header-container {
      padding: 10px 15px;
    }
    
    nav button {
      padding: 6px 12px;
      font-size: 14px;
    }
  }
  
  @media (max-width: 768px) {
    #header {
      position: sticky;
      top: 0;
    }
    
    .header-container {
      flex-wrap: nowrap;
      gap: 10px;
      padding: 8px 12px;
    }
    
    .logo-link {
      width: auto;
      justify-content: flex-start;
      margin-bottom: 0;
    }
    
    .logo-img {
      height: 36px;
    }
    
    nav {
      width: auto;
      justify-content: flex-end;
      flex: 1;
      overflow-x: auto;
      padding-bottom: 4px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    nav::-webkit-scrollbar {
      display: none;
    }
    
    main {
      padding: 20px 12px;
    }
  }
  
  @media (max-width: 480px) {
    .logo-img {
      height: 32px;
    }
    
    nav button {
      padding: 5px 10px;
      font-size: 13px;
    }
    
    #btnLogout {
      padding: 5px 8px;
    }
  }
  
  @media (max-width: 768px) {
    .logo-img {
      height: 35px;
    }
    
    nav {
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    
    nav button {
      padding: 6px 10px;
      font-size: 14px;
      flex: 1 0 calc(50% - 10px);
      max-width: 160px;
      text-align: center;
      justify-content: center;
    }
    
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .header-container {
      padding: 0 10px;
    }
    
    main {
      padding: 120px 10px 80px;
    }
    
    .panel {
      padding: 20px 15px !important;
      margin: 0 -5px;
      border-radius: 0;
    }
    
    .btn {
      padding: 10px 16px;
      font-size: 15px;
      min-width: 120px;
    }
  }

  @media (max-width: 480px) {
    .panel {
      padding: 15px 10px !important;
    }
    
    .logo-img {
      height: 30px !important;
    }
    
    nav button {
      padding: 8px 6px;
      font-size: 13px;
      flex: 1 0 calc(50% - 8px);
      max-width: none;
    }
    
    .btn {
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 12px;
      font-size: 13px;
      min-width: 100px;
    }
    
    .btn.secondary {
      margin-bottom: 0;
    }
    
    .mode-buttons {
      flex-direction: column;
      gap: 10px;
    }
    
    .mode-buttons .btn {
      width: 100%;
      margin: 0;
    }
  }

  /* Tambahan status badge */
  .status-success { color:#27ae60; font-weight:600 }
  .status-warning { color:#f39c12; font-weight:600 }
  .status-error { color:#e74c3c; font-weight:600 }
  
  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  .btn-approve {
    background: #27ae60;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-approve:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
  .btn-reject {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-reject:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="header-container">
      <nav>
        <button id="tabScanner" class="active" onclick="showPage('scanner')"><i>üì∑</i> Scanner</button>
        <button id="tabHistory" onclick="showPage('history')"><i>üìã</i> Histori</button>
        <button id="tabOts" onclick="showPage('ots')"><i>üìä</i> OTS</button>
        <button id="btnLogout" onclick="logout()"><i>üö™</i> Logout</button>
      </nav>
    </div>
  </header>

<main>
  <!-- SCANNER PANEL -->
  <section id="scanner" class="panel center">
    <div style="max-width:640px;width:100%;">
      <h2 style="margin:0 0 8px;font-size:18px">Mode</h2>
      <div class="mode-buttons" id="modeSelection">
        <button class="btn" onclick="enterCameraMode()">üì∑ Scan QR</button>
        <button class="btn secondary" onclick="enterManualMode()">‚å®Ô∏è Input Manual</button>
      </div>

      <!-- camera area -->
      <div id="cameraArea" style="display:none;margin-top:14px;" class="center">
        <div id="reader"></div>
        <div class="processing" id="procCamera" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
        <div style="margin-top:12px;">
          <button class="btn ghost" onclick="stopScanner()">Stop Camera</button>
        </div>
      </div>

      <!-- manual area -->
      <div id="manualArea" style="display:none;margin-top:14px;" class="center">
        <input id="manualInput" type="text" placeholder="Masukkan ID tiket / Kode QR" style="padding:12px;border-radius:10px;border:1px solid #222;width:100%;max-width:420px;background:#0b0c0d;color:#fff">
        <div style="margin-top:12px;">
          <button class="btn" onclick="submitManual()">Check-In</button>
          <button class="btn secondary" onclick="backToMode()">Batal</button>
        </div>
        <div class="processing" id="procManual" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
      </div>
    </div>
  </section>

  <!-- HISTORY PANEL -->
  <section id="history" class="panel" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:18px">Histori Check-in</h2>
      <div>
        <button class="btn" onclick="loadHistory()">üîÑ Refresh</button>
        <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
      </div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Timestamp</th><th>Nama</th><th>Jumlah</th><th>Jenis Tiket</th><th>Status</th><th>QR Code</th><th>Kode Pesanan</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="6">Klik Refresh untuk memuat histori...</td></tr></tbody>
      </table>
    </div>
  </section>

    <!-- OTS PANEL -->
    <section id="ots" class="panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px">OTS Tiket</h2>
        <div>
          <button class="btn" onclick="loadOts()">üîÑ Refresh</button>
          <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
      </div>
  
      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Nama</th>
              <th>Jumlah</th>
              <th>Jenis Tiket</th>
              <th>Kode Pesanan</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="otsBody">
            <tr><td colspan="6">Klik Refresh untuk memuat Tiket Ots...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
</main>

<style>
  /* Footer */
  footer {
    text-align: center;
    display: flex;
    justify-content: center;
    padding: 15px 0;
    margin-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .logo-link {
    display: block;
    padding: 5px 0;
    transition: opacity 0.2s ease;
  }
  
  .logo-link:hover {
    opacity: 0.8;
  }
  
  @media (max-width: 480px) {
    footer {
      padding: 12px 0;
      margin-top: 20px;
    }
  }
</style>

<footer>
  <a href="../index.html" class="logo-link">
    <img src="../Assets/images/logo.webp" alt="Dimsprat" class="logo-img" style="height: 25px;">
  </a>
</footer>

<!-- Modal (no auto-close) -->
<div id="resultModal" class="modal">
  <div class="modal-card" id="modalCard">
    <h1 id="modalIcon">‚ùå</h1>
    <h3 id="modalTitle">Judul</h3>
    <p id="modalMessage">Pesan</p>
    <div class="chip" id="modalSub"></div>
    <div class="actions">
      <button class="btn secondary" onclick="closeModal()">Tutup</button>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="sndValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="sndUsed" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="sndInvalid" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>

<script>
/* ==== CONFIG ==== */
const SHEET_API = "https://script.google.com/macros/s/AKfycbyiFqaZL3D0MY5xfxQEiDy-OVP02EUGKvI95Ea0qiADP9cb1e7LVqNxoUndxT-IBZ6k/exec"; 
/* ================ */

if(localStorage.getItem("panitiaLogin") !== "true") window.location.href = "login.html";

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(console.log);
}

/* --- DATABASE OFFLINE (IndexedDB) --- */
const dbName = "DimspratDB_V3"; // NAIK KE V3
const storeTickets = "tickets";
const storeHistory = "history";
const storeOts     = "ots";
const storeQueue   = "syncQueue"; 
const storeUsers   = "users"; // Store Baru

const IDB = {
  open: () => new Promise((resolve, reject) => {
    const req = indexedDB.open(dbName, 3); // Versi 3
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(storeTickets)) db.createObjectStore(storeTickets, { keyPath: "c" });
      if (!db.objectStoreNames.contains(storeHistory)) db.createObjectStore(storeHistory, { keyPath: "id", autoIncrement: true });
      if (!db.objectStoreNames.contains(storeOts))     db.createObjectStore(storeOts,     { keyPath: "id", autoIncrement: true });
      if (!db.objectStoreNames.contains(storeQueue))   db.createObjectStore(storeQueue,   { keyPath: "type_id" });
      if (!db.objectStoreNames.contains(storeUsers))   db.createObjectStore(storeUsers,   { keyPath: "u" }); // Key = username
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  }),
  // ... (fungsi put, getAll, get, clear, putBulk SAMA SEPERTI SEBELUMNYA, tidak perlu diubah) ...
  // Pastikan copy-paste helper IDB yang lengkap dari jawaban sebelumnya
  put: (store, item) => IDB.open().then(db => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).put(item);
    return new Promise(resolve => tx.oncomplete = resolve);
  }),
  getAll: (store) => IDB.open().then(db => {
    return new Promise(resolve => {
      const tx = db.transaction(store, "readonly");
      const req = tx.objectStore(store).getAll();
      req.onsuccess = () => resolve(req.result);
    });
  }),
  get: (store, key) => IDB.open().then(db => {
    return new Promise(resolve => {
      const tx = db.transaction(store, "readonly");
      const req = tx.objectStore(store).get(key);
      req.onsuccess = () => resolve(req.result);
    });
  }),
  clear: (store) => IDB.open().then(db => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).clear();
    return new Promise(resolve => tx.oncomplete = resolve);
  }),
  putBulk: (store, data) => IDB.open().then(db => {
    const tx = db.transaction(store, "readwrite");
    const st = tx.objectStore(store);
    data.forEach(item => st.put(item));
    return new Promise(resolve => tx.oncomplete = resolve);
  })
};

/* --- CORE SYNCHRONIZATION --- */

window.addEventListener('load', async () => {
  updateSyncStatus();
  refreshHistoryUI(); // Load dari DB Lokal
  refreshOtsUI();     // Load dari DB Lokal
  
  if(navigator.onLine) {
    await fullSync();
  }
});

window.addEventListener('online', async () => {
  showToast("üîó Online. Sinkronisasi...");
  await fullSync();
});

// Full Sync: Upload dulu -> Baru Download (Mencegah overwrite status Used)
async function fullSync() {
  await syncUp();   // 1. Kirim data offline kita ke server
  await syncDown(); // 2. Ambil data terbaru dari server
}

async function syncUp() {
  const queue = await IDB.getAll(storeQueue);
  if (queue.length === 0) return;

  document.getElementById("syncStatus").innerText = "‚¨Ü Uploading...";

  // Pisahkan data queue berdasarkan tipe
  const payload = {
    scans: queue.filter(q => q.type === 'scan').map(q => q.data),
    history: queue.filter(q => q.type === 'history').map(q => q.data),
    ots: queue.filter(q => q.type === 'ots').map(q => q.data)
  };

  try {
    const res = await fetch(`${SHEET_API}?action=sync_up`, {
      method: "POST", 
      body: JSON.stringify(payload)
    });
    const json = await res.json();

    if (json.status === "success") {
      await IDB.clear(storeQueue); // Bersihkan antrian
      showToast("‚úÖ Data Offline Terkirim!");
      updateSyncStatus();
    }
  } catch (e) {
    console.log("Sync Up Failed:", e);
  }
}

async function syncDown() {
  try {
    document.getElementById("syncStatus").innerText = "‚¨á Downloading DB...";
    const res = await fetch(`${SHEET_API}?action=sync_down`);
    const json = await res.json();

    if (json.status === "success") {
      // 1. Simpan Tiket
      await IDB.clear(storeTickets);
      await IDB.putBulk(storeTickets, json.tickets);
      
      // 2. Simpan User (Panitia) untuk Login Offline
      if(json.users && json.users.length > 0){
        await IDB.clear(storeUsers);
        await IDB.putBulk(storeUsers, json.users);
        console.log("User DB Updated: " + json.users.length);
      }
      
      localStorage.setItem("lastSync", new Date().toLocaleTimeString());
      updateSyncStatus();
    }
  } catch (e) {
    console.log("Sync Down Failed:", e);
  }
}

function updateSyncStatus() {
  IDB.getAll(storeQueue).then(q => {
    const el = document.getElementById("syncStatus") || createStatusEl();
    if (q.length > 0) {
      el.innerText = `‚ö†Ô∏è ${q.length} Pending`;
      el.style.color = "#f39c12";
      el.style.borderColor = "#f39c12";
    } else {
      el.innerText = `‚úÖ Sync (${localStorage.getItem("lastSync")||"-"})`;
      el.style.color = "#27ae60";
      el.style.borderColor = "#27ae60";
    }
  });
}

function createStatusEl() {
  const el = document.createElement("div");
  el.id = "syncStatus";
  el.style.cssText = "position:fixed; bottom:10px; right:10px; background:rgba(0,0,0,0.8); padding:6px 12px; border-radius:20px; font-size:12px; border:1px solid #444; z-index:9999;";
  document.body.appendChild(el);
  return el;
}

/* --- VALIDASI (UPDATE LOKAL DULU) --- */
async function validateCode(code) {
  document.getElementById('procCamera').style.display = 'block';
  
  try {
    // 1. Cek DB Lokal
    const ticket = await IDB.get(storeTickets, code);
    
    document.getElementById('procCamera').style.display = 'none';

    if (!ticket) {
      playSound('invalid');
      showResultModal('error', '‚ùå Tidak Ditemukan', 'Kode tiket tidak ada di database HP.');
      return;
    }

    // 2. Cek Status
    if (ticket.s === 1) {
      playSound('used');
      showResultModal('warning', '‚ö†Ô∏è Sudah Terpakai', `Nama: ${ticket.n}\nJenis: ${ticket.j}\nOrder: ${ticket.o}`);
    } else {
      // 3. VALID! -> Update DB Lokal LANGSUNG
      ticket.s = 1; 
      await IDB.put(storeTickets, ticket); // SAVE: Status Used PERMANEN di HP

      // 4. Siapkan Data Log
      const logData = {
        ts: formatWIB(new Date()),
        c: ticket.c,
        n: ticket.n,
        j: ticket.j,
        q: ticket.q,
        o: ticket.o,
        st: "Berhasil"
      };

      // 5. Simpan ke History Lokal
      await IDB.put(storeHistory, logData);
      refreshHistoryUI();

      // 6. Masukkan ke Antrian Sync (Queue)
      // Gunakan key unik agar tidak duplikat di queue
      await IDB.put(storeQueue, { type_id: "scan_"+code, type: "scan", data: { c: code } });
      await IDB.put(storeQueue, { type_id: "hist_"+code+"_"+Date.now(), type: "history", data: logData });
      
      playSound('valid');
      showResultModal('success', '‚úÖ Check-in Berhasil', `Nama: ${ticket.n}\nJenis: ${ticket.j}`);
      updateSyncStatus();

      // 7. Coba Sync Background
      if(navigator.onLine) syncUp();
    }
  } catch (err) {
    alert("Error: " + err);
  }
}

/* --- UI HELPERS (History & OTS Offline) --- */
function refreshHistoryUI() {
  const body = document.getElementById('historyBody');
  if (!body) return;
  
  IDB.getAll(storeHistory).then(records => {
    if (records.length === 0) {
      body.innerHTML = `<tr><td colspan="7">Belum ada scan (Offline Mode).</td></tr>`;
      return;
    }
    // Sort descending (terbaru diatas)
    records.reverse(); 
    body.innerHTML = records.map(r => `
      <tr>
        <td>${r.ts}</td>
        <td>${escapeHtml(r.n)}</td>
        <td>${escapeHtml(r.q)}</td>
        <td>${escapeHtml(r.j)}</td>
        <td class="status-success">${r.st}</td>
        <td>${r.c}</td>
        <td>${r.o}</td>
      </tr>
    `).join('');
  });
}

function refreshOtsUI() {
  const body = document.getElementById('otsBody');
  if (!body) return;
  
  IDB.getAll(storeOts).then(records => {
    if (records.length === 0) {
      body.innerHTML = `<tr><td colspan="7">Belum ada data OTS.</td></tr>`;
      return;
    }
    records.reverse();
    body.innerHTML = records.map(r => `
      <tr>
        <td>${r.ts}</td>
        <td>${escapeHtml(r.n)}</td>
        <td>${escapeHtml(r.q)}</td>
        <td>${escapeHtml(r.j)}</td>
        <td>${escapeHtml(r.o)}</td>
        <td>${escapeHtml(r.st)}</td>
        <td>-</td>
      </tr>
    `).join('');
  });
}

// Fungsi Tambah OTS (Simulasi jika ada form input OTS)
// Anda bisa panggil ini dari form input OTS Anda
async function addOtsOffline(nama, jumlah, jenis) {
  const data = {
    ts: formatWIB(new Date()),
    n: nama, q: jumlah, j: jenis, o: "OTS-"+Date.now(), st: "Lunas"
  };
  
  await IDB.put(storeOts, data); // Simpan Lokal
  await IDB.put(storeQueue, { type_id: "ots_"+Date.now(), type: "ots", data: data }); // Queue
  
  refreshOtsUI();
  updateSyncStatus();
  if(navigator.onLine) syncUp();
}

/* --- STANDARD FUNCTIONS (Scanner, Modal, Sounds) --- */
// (Bagian ini sama seperti file sebelumnya, pastikan fungsi showPage, scanner, dll ada)

let qrScanner = null;
const sndValid = document.getElementById('sndValid');
const sndUsed = document.getElementById('sndUsed');
const sndInvalid = document.getElementById('sndInvalid');

function showPage(page){
  document.getElementById('scanner').style.display = page==='scanner' ? 'block' : 'none';
  document.getElementById('history').style.display = page==='history' ? 'block' : 'none';
  document.getElementById('ots').style.display = page==='ots' ? 'block' : 'none';
  document.getElementById('tabScanner').classList.toggle('active', page==='scanner');
  document.getElementById('tabHistory').classList.toggle('active', page==='history');
  document.getElementById('tabOts').classList.toggle('active', page==='ots');
  
  if(page==='history') refreshHistoryUI();
  if(page==='ots') refreshOtsUI();
}
window.showPage = showPage;

/* Modes & Scanner Implementation */
function enterCameraMode(){
  document.getElementById('modeSelection').style.display = 'none';
  document.getElementById('cameraArea').style.display = 'block';
  startScanner();
}
function enterManualMode(){
  document.getElementById('modeSelection').style.display = 'none';
  document.getElementById('manualArea').style.display = 'block';
  setTimeout(()=>document.getElementById('manualInput').focus(),100);
}
function backToMode(){
  stopScanner();
  document.getElementById('modeSelection').style.display = 'flex';
  document.getElementById('cameraArea').style.display = 'none';
  document.getElementById('manualArea').style.display = 'none';
  document.getElementById('manualInput').value = '';
}
async function startScanner(){
  const reader = document.getElementById('reader');
  document.getElementById('procCamera').style.display = 'none';
  qrScanner = new Html5Qrcode("reader");
  try {
    await qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: {width:260,height:260} }, qrMessage => {
      stopScanner();
      validateCode(qrMessage);
    });
  } catch (err) { alert('Kamera Error: ' + err); backToMode(); }
}
function stopScanner(){ if(qrScanner){ qrScanner.stop().then(()=>qrScanner.clear()).catch(()=>{}); qrScanner = null; } }
function submitManual(){ const c=document.getElementById('manualInput').value.trim(); if(c) validateCode(c); }

/* Modal */
function showResultModal(type,title,msg){
  const m = document.getElementById('resultModal');
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalMessage').innerText = msg;
  document.getElementById('modalSub').innerText = formatWIB(new Date());
  
  const card = document.getElementById('modalCard');
  const icon = document.getElementById('modalIcon');
  
  if(type==='success'){ icon.innerText='‚úÖ'; card.style.border='2px solid #27ae60'; }
  else if(type==='warning'){ icon.innerText='‚ö†Ô∏è'; card.style.border='2px solid #f39c12'; }
  else { icon.innerText='‚ùå'; card.style.border='2px solid #e74c3c'; }
  m.classList.add('show');
}
function closeModal(){ document.getElementById('resultModal').classList.remove('show'); backToMode(); }
function playSound(t){ try{ if(t==='valid')sndValid.play(); else if(t==='used')sndUsed.play(); else sndInvalid.play(); }catch(e){} }
function formatWIB(d){ return new Date(d).toLocaleString('id-ID', {timeZone:"Asia/Jakarta", hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'}) + " WIB"; }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
async function logout(){ localStorage.removeItem("panitiaLogin"); window.location.href="login.html"; }

// Keyboard listeners
document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && document.getElementById('manualArea').style.display!=='none') submitManual();
  if(e.key==='Escape' && document.getElementById('resultModal').classList.contains('show')) closeModal();
});
</script>
</body>
</html>
