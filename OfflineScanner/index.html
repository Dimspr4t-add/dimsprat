<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dimsprat Scanner</title>
  <link rel="icon" type="image/x-icon" href="../Assets/images/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Assets/style.css">
  <link rel="stylesheet" href="../Assets/js.css">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* Global Styles */
  :root {
    --primary: #e63946;
    --secondary: #1d3557;
    --accent: #ff4d4d;
    --success: #27ae60;
    --warn: #f39c12;
    --danger: #e74c3c;
    --text: #f8f9fa;
    --muted: #adb5bd;
    --bg-dark: #0f172a;
    --bg-darker: #0b1120;
    --border: rgba(255, 255, 255, 0.1);
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Rajdhani', sans-serif;
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }
  
  /* Header Styles */
  #header {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    transition: all 0.3s ease;
  }
  
  .header-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 10px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
  }
  
  .logo-img {
    height: 40px;
    width: auto;
    max-width: 180px;
    object-fit: contain;
    transition: transform 0.3s ease, opacity 0.2s ease;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  }
  
  .logo-img:hover {
    transform: scale(1.03);
  }
  
  /* Navigation */
  nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
  }
  
  nav button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #fff;
    padding: 8px 18px;
    border-radius: 50px;
    cursor: pointer;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 15px;
    white-space: nowrap;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  nav button i {
    font-size: 1.1em;
  }
  
  nav button:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
  }
  
  nav button:active {
    transform: translateY(0);
  }
  
  nav button.active {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 4px 15px rgba(255, 45, 45, 0.2);
  }
  
  #btnLogout {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
    border-color: rgba(255, 107, 107, 0.2);
  }
  
  #btnLogout:hover {
    background: rgba(255, 107, 107, 0.2);
  }

  /* Main content */
  main {
    flex: 1;
    padding: 30px 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .panel {
    background: rgba(30, 41, 59, 0.6);
    padding: 30px;
    border-radius: 20px;
    min-width: 320px;
    max-width: 100%;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), #ff9f43);
    opacity: 0.8;
  }
  
  .panel:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }
  .center {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    text-align: center;
  }

  /* Mode selection */
  .mode-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 20px 0;
  }
  
  .btn {
    background: var(--accent);
    border: none;
    padding: 12px 28px;
    border-radius: 50px;
    color: #fff;
    cursor: pointer;
    font-weight: 700;
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    letter-spacing: 0.5px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 150px;
    position: relative;
    overflow: hidden;
    z-index: 1;
  }
  
  .btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
  }
  
  .btn:hover::after {
    opacity: 1;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 45, 45, 0.3);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn.secondary {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text);
  }
  
  .btn.secondary:hover {
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    color: var(--muted);
  }
  
  .btn.ghost:hover {
    background: rgba(255, 255, 255, 0.03);
    border-color: var(--accent);
    color: #fff;
  }

  /* Scanner area */
  #reader {width:320px;margin:0 auto}
  .processing{display:flex;align-items:center;gap:10px;color:var(--muted);margin-top:8px}
  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.8));backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:999}
  .modal.show{display:flex}
  .modal-card{background:linear-gradient(180deg,#0f1214,#151617);padding:22px;border-radius:14px;min-width:300px;max-width:420px;text-align:center;box-shadow:0 14px 38px rgba(0,0,0,0.6)}
  .modal-card h1{font-size:48px;margin:0}
  .modal-card h3{margin:12px 0 8px;font-size:20px}
  .modal-card p{margin:0;color:var(--muted);white-space:pre-line}
  .modal-card .actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:13px;margin-top:10px}

  /* Table (history) */
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:var(--muted);font-weight:600;font-size:13px}
  tbody tr:hover td{background:rgba(255,255,255,0.01)}

  /* Form Elements */
  input[type="text"],
  input[type="number"],
  input[type="email"],
  input[type="password"],
  select,
  textarea {
    width: 100%;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.7);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    transition: all 0.2s ease;
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 77, 77, 0.2);
  }
  
  /* Table Styling */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 20px 0;
    font-size: 14px;
    border-radius: 12px;
    overflow: hidden;
  }
  
  th, td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  th {
    background: rgba(255, 255, 255, 0.03);
    color: var(--muted);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
  }
  
  tbody tr {
    transition: background-color 0.2s ease;
  }
  
  tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
  }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .header-container {
      padding: 10px 16px;
    }
    
    nav {
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    
    .panel {
      padding: 20px;
    }
  }
  
  @media (max-width: 992px) {
    .header-container {
      padding: 10px 15px;
    }
    
    nav button {
      padding: 6px 12px;
      font-size: 14px;
    }
  }
  
  @media (max-width: 768px) {
    #header {
      position: sticky;
      top: 0;
    }
    
    .header-container {
      flex-wrap: nowrap;
      gap: 10px;
      padding: 8px 12px;
    }
    
    .logo-link {
      width: auto;
      justify-content: flex-start;
      margin-bottom: 0;
    }
    
    .logo-img {
      height: 36px;
    }
    
    nav {
      width: auto;
      justify-content: flex-end;
      flex: 1;
      overflow-x: auto;
      padding-bottom: 4px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    nav::-webkit-scrollbar {
      display: none;
    }
    
    main {
      padding: 20px 12px;
    }
  }
  
  @media (max-width: 480px) {
    .logo-img {
      height: 32px;
    }
    
    nav button {
      padding: 5px 10px;
      font-size: 13px;
    }
    
    #btnLogout {
      padding: 5px 8px;
    }
  }
  
  @media (max-width: 768px) {
    .logo-img {
      height: 35px;
    }
    
    nav {
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    
    nav button {
      padding: 6px 10px;
      font-size: 14px;
      flex: 1 0 calc(50% - 10px);
      max-width: 160px;
      text-align: center;
      justify-content: center;
    }
    
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .header-container {
      padding: 0 10px;
    }
    
    main {
      padding: 120px 10px 80px;
    }
    
    .panel {
      padding: 20px 15px !important;
      margin: 0 -5px;
      border-radius: 0;
    }
    
    .btn {
      padding: 10px 16px;
      font-size: 15px;
      min-width: 120px;
    }
  }

  @media (max-width: 480px) {
    .panel {
      padding: 15px 10px !important;
    }
    
    .logo-img {
      height: 30px !important;
    }
    
    nav button {
      padding: 8px 6px;
      font-size: 13px;
      flex: 1 0 calc(50% - 8px);
      max-width: none;
    }
    
    .btn {
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 12px;
      font-size: 13px;
      min-width: 100px;
    }
    
    .btn.secondary {
      margin-bottom: 0;
    }
    
    .mode-buttons {
      flex-direction: column;
      gap: 10px;
    }
    
    .mode-buttons .btn {
      width: 100%;
      margin: 0;
    }
  }

  /* Tambahan status badge */
  .status-success { color:#27ae60; font-weight:600 }
  .status-warning { color:#f39c12; font-weight:600 }
  .status-error { color:#e74c3c; font-weight:600 }
  
  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  .btn-approve {
    background: #27ae60;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-approve:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
  .btn-reject {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-reject:disabled {
    background: #7f8c8d;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="header-container">
      <nav>
        <button id="tabScanner" class="active" onclick="showPage('scanner')"><i>üì∑</i> Scanner</button>
        <button id="tabHistory" onclick="showPage('history')"><i>üìã</i> Histori</button>
        <button id="tabOts" onclick="showPage('ots')"><i>üìä</i> OTS</button>
        <button id="btnLogout" onclick="logout()"><i>üö™</i> Logout</button>
      </nav>
    </div>
  </header>

<main>
  <!-- SCANNER PANEL -->
  <section id="scanner" class="panel center">
    <div style="max-width:640px;width:100%;">
      <h2 style="margin:0 0 8px;font-size:18px">Mode</h2>
      <div class="mode-buttons" id="modeSelection">
        <button class="btn" onclick="enterCameraMode()">üì∑ Scan QR</button>
        <button class="btn secondary" onclick="enterManualMode()">‚å®Ô∏è Input Manual</button>
      </div>

      <!-- camera area -->
      <div id="cameraArea" style="display:none;margin-top:14px;" class="center">
        <div id="reader"></div>
        <div class="processing" id="procCamera" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
        <div style="margin-top:12px;">
          <button class="btn ghost" onclick="stopScanner()">Stop Camera</button>
        </div>
      </div>

      <!-- manual area -->
      <div id="manualArea" style="display:none;margin-top:14px;" class="center">
        <input id="manualInput" type="text" placeholder="Masukkan ID tiket / Kode QR" style="padding:12px;border-radius:10px;border:1px solid #222;width:100%;max-width:420px;background:#0b0c0d;color:#fff">
        <div style="margin-top:12px;">
          <button class="btn" onclick="submitManual()">Check-In</button>
          <button class="btn secondary" onclick="backToMode()">Batal</button>
        </div>
        <div class="processing" id="procManual" style="display:none"><div class="spinner"></div><div>Memproses...</div></div>
      </div>
    </div>
  </section>

  <!-- HISTORY PANEL -->
  <section id="history" class="panel" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:18px">Histori Check-in</h2>
      <div>
        <button class="btn" onclick="loadHistory()">üîÑ Refresh</button>
        <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
      </div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Timestamp</th><th>Nama</th><th>Jumlah</th><th>Jenis Tiket</th><th>Status</th><th>QR Code</th><th>Kode Pesanan</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="6">Klik Refresh untuk memuat histori...</td></tr></tbody>
      </table>
    </div>
  </section>

    <!-- OTS PANEL -->
    <section id="ots" class="panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px">OTS Tiket</h2>
        <div>
          <button class="btn" onclick="loadOts()">üîÑ Refresh</button>
          <button class="btn secondary" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
      </div>
  
      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Nama</th>
              <th>Jumlah</th>
              <th>Jenis Tiket</th>
              <th>Kode Pesanan</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="otsBody">
            <tr><td colspan="6">Klik Refresh untuk memuat Tiket Ots...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
</main>

<style>
  /* Footer */
  footer {
    text-align: center;
    display: flex;
    justify-content: center;
    padding: 15px 0;
    margin-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .logo-link {
    display: block;
    padding: 5px 0;
    transition: opacity 0.2s ease;
  }
  
  .logo-link:hover {
    opacity: 0.8;
  }
  
  @media (max-width: 480px) {
    footer {
      padding: 12px 0;
      margin-top: 20px;
    }
  }
</style>

<footer>
  <a href="../index.html" class="logo-link">
    <img src="../Assets/images/logo.webp" alt="Dimsprat" class="logo-img" style="height: 25px;">
  </a>
</footer>

<!-- Modal (no auto-close) -->
<div id="resultModal" class="modal">
  <div class="modal-card" id="modalCard">
    <h1 id="modalIcon">‚ùå</h1>
    <h3 id="modalTitle">Judul</h3>
    <p id="modalMessage">Pesan</p>
    <div class="chip" id="modalSub"></div>
    <div class="actions">
      <button class="btn secondary" onclick="closeModal()">Tutup</button>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="sndValid" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="sndUsed" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="sndInvalid" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>

<script>
/* ===============================================================
   CONFIG & SAFETY
   =============================================================== */
const SHEET_API = "https://script.google.com/macros/s/AKfycbyiFqaZL3D0MY5xfxQEiDy-OVP02EUGKvI95Ea0qiADP9cb1e7LVqNxoUndxT-IBZ6k/exec"; 

// Cek Login
if(localStorage.getItem("panitiaLogin") !== "true") window.location.href = "login.html";

// Register Service Worker (Hanya jalan di HTTPS atau Localhost)
if ('serviceWorker' in navigator) {
  // Cek protokol dulu
  if (window.location.protocol === 'file:') {
    alert("PERINGATAN: Fitur Offline (Service Worker) tidak jalan jika file dibuka langsung (file://). Gunakan Localhost atau Hosting.");
  } else {
    navigator.serviceWorker.register('sw.js').catch(e => console.log("SW Fail:", e));
  }
}

/* ===============================================================
   DATABASE ROBUST (KEBAL ERROR)
   =============================================================== */
// Kita naikkan ke V5 untuk memaksa browser membuat struktur baru yang bersih
const dbName = "DimspratDB_V5"; 
const storeTickets = "tickets";
const storeHistory = "history";
const storeOts     = "ots";
const storeQueue   = "syncQueue";
const storeUsers   = "users";

const IDB = {
  open: () => new Promise((resolve, reject) => {
    const req = indexedDB.open(dbName, 5); // Versi 5
    req.onupgradeneeded = (e) => {
      console.log("Upgrade DB...");
      const db = e.target.result;
      const create = (name, key, auto) => { 
        if(db.objectStoreNames.contains(name)) db.deleteObjectStore(name); // Hapus yang lama biar bersih
        db.createObjectStore(name, {keyPath: key, autoIncrement: auto}); 
      };
      create(storeTickets, "c", false);
      create(storeQueue, "type_id", false);
      create(storeUsers, "u", false);
      create(storeHistory, "id", true);
      create(storeOts, "id", true);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  }),
  // SAFETY UPDATE: Menambahkan "|| []" agar selalu return Array
  getAll: (st) => IDB.open().then(db => {
    return new Promise(r => {
      if(!db.objectStoreNames.contains(st)) return r([]); // Kalau store ga ada, return array kosong
      const tx = db.transaction(st, "readonly");
      const req = tx.objectStore(st).getAll();
      req.onsuccess = () => r(req.result || []); // FORCE ARRAY
      req.onerror = () => r([]); // FORCE ARRAY ON ERROR
    });
  }),
  get: (st, key) => IDB.open().then(db => {
    return new Promise(r => {
      if(!db.objectStoreNames.contains(st)) return r(null);
      const tx = db.transaction(st, "readonly");
      const req = tx.objectStore(st).get(key);
      req.onsuccess = () => r(req.result);
      req.onerror = () => r(null);
    });
  }),
  put: (st, val) => IDB.open().then(db => {
    const tx = db.transaction(st, "readwrite");
    tx.objectStore(st).put(val);
    return new Promise(r => tx.oncomplete = r);
  }),
  clear: (st) => IDB.open().then(db => {
    const tx = db.transaction(st, "readwrite");
    tx.objectStore(st).clear();
    return new Promise(r => tx.oncomplete = r);
  }),
  putBulk: (st, data) => IDB.open().then(db => {
    const tx = db.transaction(st, "readwrite");
    const s = tx.objectStore(st);
    if(Array.isArray(data)) data.forEach(i => s.put(i));
    return new Promise(r => tx.oncomplete = r);
  })
};

/* ===============================================================
   LOGIKA UTAMA
   =============================================================== */

window.addEventListener('load', async () => {
  // Update UI dulu dengan data kosong/lokal agar tidak blank
  updateSyncStatus();
  refreshHistoryUI();
  refreshOtsUI();
  
  // Cek koneksi
  if(navigator.onLine) {
    await fullSync();
  }
  
  // Interval Sync
  setInterval(() => { if(navigator.onLine) fullSync(); }, 30000);
});

window.addEventListener('online', async () => { 
  showToast("üîó Online Kembali. Sinkronisasi..."); 
  await fullSync(); 
});

async function fullSync() {
  await syncUp();
  await syncDown();
}

async function syncUp() {
  const queue = await IDB.getAll(storeQueue);
  if (!queue || queue.length === 0) return; // Safety check
  
  const el = document.getElementById("syncStatus");
  if(el) el.innerText = "‚¨Ü Uploading...";

  // Safety filter (mencegah error 'filter is not a function')
  const payload = {
    scans: Array.isArray(queue) ? queue.filter(q => q.type === 'scan').map(q => q.data) : [],
    history: Array.isArray(queue) ? queue.filter(q => q.type === 'history').map(q => q.data) : [],
    ots: Array.isArray(queue) ? queue.filter(q => q.type === 'ots').map(q => q.data) : []
  };

  try {
    const res = await fetch(`${SHEET_API}?action=sync_up`, { method: "POST", body: JSON.stringify(payload) });
    const json = await res.json();
    if (json.status === "success") {
      await IDB.clear(storeQueue);
      showToast("‚úÖ Data Terkirim!");
      updateSyncStatus();
    }
  } catch (e) { console.log("Skip SyncUp (Offline)"); }
}

async function syncDown() {
  try {
    const el = document.getElementById("syncStatus");
    if(el) el.innerText = "‚¨á Syncing...";
    
    const res = await fetch(`${SHEET_API}?action=sync_down`);
    const json = await res.json();
    
    if (json.status === "success") {
      if(json.tickets && Array.isArray(json.tickets)) {
        await IDB.clear(storeTickets);
        await IDB.putBulk(storeTickets, json.tickets);
      }
      if(json.users && Array.isArray(json.users)) {
        await IDB.clear(storeUsers);
        await IDB.putBulk(storeUsers, json.users);
      }
      localStorage.setItem("lastSync", new Date().toLocaleTimeString());
      updateSyncStatus();
    }
  } catch (e) { console.log("Skip SyncDown (Offline)"); }
}

/* ===============================================================
   VALIDASI TIKET
   =============================================================== */
async function validateCode(code) {
  document.getElementById('manualInput').blur();
  document.getElementById('procCamera').style.display = 'block';

  try {
    const ticket = await IDB.get(storeTickets, code);
    document.getElementById('procCamera').style.display = 'none';
    
    const ts = formatWIB(new Date());
    let logStatus = "";

    // KASUS 1: Tidak Ditemukan
    if (!ticket) {
      playSound('invalid');
      showResultModal('error', '‚ùå Tidak Dikenal', `Kode: ${code}\nTiket tidak ada di database.`);
      logStatus = "Invalid/Tidak Dikenal";
      await addToQueue("history", { ts, c: code, n: "-", j: "-", q: "-", o: "-", st: logStatus });
      return;
    }

    // KASUS 2: Sudah Dipakai
    if (ticket.s === 1) {
      playSound('used');
      showResultModal('warning', '‚ö†Ô∏è Sudah Terpakai', `Nama: ${ticket.n}\nJenis: ${ticket.j}\nStatus: Used/Approved`);
      logStatus = "Gagal - Sudah Terpakai";
      await addToQueue("history", { ts, c: ticket.c, n: ticket.n, j: ticket.j, q: ticket.q, o: ticket.o, st: logStatus });
      return;
    }

    // KASUS 3: Sukses
    playSound('valid');
    showResultModal('success', '‚úÖ Check-in Berhasil', `Nama: ${ticket.n}\nJenis: ${ticket.j}`);
    logStatus = "Berhasil";

    ticket.s = 1; 
    await IDB.put(storeTickets, ticket);
    await addToQueue("scan", { c: ticket.c });
    await addToQueue("history", { ts, c: ticket.c, n: ticket.n, j: ticket.j, q: ticket.q, o: ticket.o, st: logStatus });

    if(navigator.onLine) syncUp();

  } catch (err) {
    alert("Error DB: " + err);
  }
}

async function addToQueue(type, data) {
  const id = type + "_" + Date.now() + "_" + Math.random().toString(36).substr(2,4);
  await IDB.put(storeQueue, { type_id: id, type: type, data: data });
  updateSyncStatus();
  refreshHistoryUI();
}

/* ===============================================================
   UI RENDERERS (SAFETY ADDED)
   =============================================================== */
function refreshHistoryUI() {
  const body = document.getElementById('historyBody');
  IDB.getAll(storeQueue).then(q => {
    // Safety check: pastikan q adalah array
    const safeQ = Array.isArray(q) ? q : [];
    
    const logs = safeQ.filter(x => x.type === 'history').map(x => x.data);
    
    if(logs.length === 0) { 
       body.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#888">Belum ada scan baru di sesi ini.</td></tr>`;
       return; 
    }
    
    logs.reverse();
    body.innerHTML = logs.map(r => {
      let cls = "st-warn";
      if(r.st.includes("Berhasil")) cls = "st-success";
      if(r.st.includes("Invalid")) cls = "st-danger";
      return `<tr>
        <td>${r.ts.split(' ')[1] || r.ts}</td>
        <td>${escapeHtml(r.n)}</td>
        <td>${r.q}</td>
        <td>${r.j}</td>
        <td class="${cls}">${r.st}</td>
        <td><small>${r.c}</small></td>
      </tr>`;
    }).join('');
  });
}

function refreshOtsUI() {
  const body = document.getElementById('otsBody');
  IDB.getAll(storeOts).then(recs => {
    // Safety check
    const safeRecs = Array.isArray(recs) ? recs : [];
    
    if(safeRecs.length === 0) { 
        body.innerHTML = `<tr><td colspan="5">Belum ada data OTS offline.</td></tr>`; 
        return; 
    }
    safeRecs.reverse();
    body.innerHTML = safeRecs.map(r => `<tr><td>${r.ts}</td><td>${r.n}</td><td>${r.q}</td><td>${r.j}</td><td>${r.st}</td></tr>`).join('');
  });
}

function updateSyncStatus() {
  IDB.getAll(storeQueue).then(q => {
    const safeQ = Array.isArray(q) ? q : [];
    
    let el = document.getElementById("syncStatus");
    if(!el) {
      el = document.createElement("div"); el.id = "syncStatus";
      el.style.cssText = "position:fixed; bottom:10px; right:10px; background:rgba(0,0,0,0.85); padding:8px 16px; border-radius:30px; font-size:13px; border:1px solid #444; z-index:9999; backdrop-filter:blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.5);";
      document.body.appendChild(el);
    }
    
    const count = safeQ.length;
    const last = localStorage.getItem("lastSync") || "-";
    
    if (count > 0) {
      el.innerHTML = `‚ö†Ô∏è <b>${count}</b> Pending Upload`;
      el.style.color = "#f1c40f"; el.style.borderColor = "#f1c40f";
    } else {
      el.innerHTML = `‚úÖ Sync OK <small style="opacity:0.7">(${last})</small>`;
      el.style.color = "#2ecc71"; el.style.borderColor = "#2ecc71";
    }
  });
}

/* ===============================================================
   FUNGSI STANDARD (SAMA)
   =============================================================== */
let qrScanner = null;
const sndValid = document.getElementById('sndValid');
const sndUsed = document.getElementById('sndUsed');
const sndInvalid = document.getElementById('sndInvalid');

function showPage(page){
  ['scanner','history','ots'].forEach(p => {
    document.getElementById(p).style.display = (p===page) ? 'block' : 'none';
    const btn = document.getElementById('tab'+p.charAt(0).toUpperCase()+p.slice(1));
    if(btn) (p===page) ? btn.classList.add('active') : btn.classList.remove('active');
  });
  if(page==='history') refreshHistoryUI();
  if(page==='ots') refreshOtsUI();
}
window.showPage = showPage;

function enterCameraMode(){ document.getElementById('modeSelection').style.display='none'; document.getElementById('cameraArea').style.display='block'; startScanner(); }
function enterManualMode(){ document.getElementById('modeSelection').style.display='none'; document.getElementById('manualArea').style.display='block'; setTimeout(()=>document.getElementById('manualInput').focus(),100); }
function backToMode(){ stopScanner(); document.getElementById('modeSelection').style.display='flex'; document.getElementById('cameraArea').style.display='none'; document.getElementById('manualArea').style.display='none'; document.getElementById('manualInput').value=''; }

async function startScanner(){
  const reader = document.getElementById('reader');
  document.getElementById('procCamera').style.display = 'none';
  qrScanner = new Html5Qrcode("reader");
  try {
    await qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: {width:260,height:260} }, qrMessage => { stopScanner(); validateCode(qrMessage); });
  } catch (err) { alert('Kamera Error: ' + err); backToMode(); }
}
function stopScanner(){ if(qrScanner){ qrScanner.stop().then(()=>qrScanner.clear()).catch(()=>{}); qrScanner = null; } }
function submitManual(){ const c=document.getElementById('manualInput').value.trim(); if(c) validateCode(c); }

function showResultModal(type,title,msg){
  const m = document.getElementById('resultModal');
  const card = document.getElementById('modalCard');
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalMessage').innerText = msg;
  document.getElementById('modalSub').innerText = formatWIB(new Date());
  document.getElementById('modalIcon').innerText = (type==='success') ? '‚úÖ' : (type==='warning') ? '‚ö†Ô∏è' : '‚ùå';
  card.className = 'modal-card';
  card.style.border = `2px solid ${(type==='success')?'#27ae60':(type==='warning')?'#f39c12':'#e74c3c'}`;
  m.classList.add('show');
}
function closeModal(){ document.getElementById('resultModal').classList.remove('show'); backToMode(); }
function playSound(t){ try{ if(t==='valid')sndValid.play(); else if(t==='used')sndUsed.play(); else sndInvalid.play(); }catch(e){} }
function showToast(msg){ const t=document.createElement("div"); t.innerText=msg; t.style.cssText="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:10px 20px;border-radius:30px;z-index:9999;border:1px solid #555"; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
function formatWIB(d){ return new Date(d).toLocaleString('id-ID', {timeZone:"Asia/Jakarta", hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
async function logout(){ localStorage.removeItem("panitiaLogin"); window.location.href="login.html"; }

document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && document.getElementById('manualArea').style.display!=='none') submitManual();
  if(e.key==='Escape' && document.getElementById('resultModal').classList.contains('show')) closeModal();
});
</script>
</body>
</html>
